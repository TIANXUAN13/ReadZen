<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日一文 | 享受阅读时光</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- 引入字体 (思源宋体，更有文学感) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- 自定义配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'serif'],
                    },
                    colors: {
                        'paper': '#fdfbf7', // 仿纸张颜色
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
        }
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; 
        }

        /* 禅意字体 */
        .font-serif-reading {
            font-family: "Noto Serif SC", "Source Han Serif SC", "Source Han Serif", "Songti SC", "SimSun", serif;
        }

        /* 进度条样式 */
        .reading-progress-bar {
            height: 2px;
            background: linear-gradient(to right, #3b82f6, #60a5fa);
            position: absolute;
            bottom: -1px;
            left: 0;
            transition: width 0.1s ease-out;
            z-index: 60;
        }

        /* Toast 动画 */
        .toast-enter-active, .toast-leave-active {
            transition: all 0.3s ease;
        }
        .toast-enter-from {
            transform: translateY(-20px);
            opacity: 0;
        }
        .toast-leave-to {
            transform: translateY(-20px);
            opacity: 0;
        }

        /* 玻璃磨砂效果 */
        .glass-panel {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* 认证表单切换动画 */
        .auth-slide-enter-active, .auth-slide-leave-active {
            transition: all 0.3s ease;
        }
        .auth-slide-enter-from {
            opacity: 0;
            transform: translateX(20px);
        }
        .auth-slide-leave-to {
            opacity: 0;
            transform: translateX(-20px);
        }

        /* 侧边栏导航激活项滑动动画 */
        .nav-indicator {
            position: absolute;
            left: 8px;
            right: 8px;
            height: 48px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        .nav-item-content {
            position: relative;
            z-index: 10;
        }

        /* 侧边栏玻璃感 */
        .sidebar-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .dark .sidebar-glass {
            background: rgba(17, 24, 39, 0.8);
        }
    </style>
</head>
<body class="antialiased h-screen flex flex-col">

    <div id="app" class="w-full h-full flex flex-row">
        <!-- Toast 通知 -->
        <div class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none">
            <transition-group name="toast">
                <div 
                    v-for="toast in toasts" 
                    :key="toast.id"
                    :class="[
                        'px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 pointer-events-auto transition-all',
                        toast.type === 'error' ? 'bg-red-500 text-white' : (toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white')
                    ]"
                >
                    <svg v-if="toast.type === 'success'" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <svg v-else-if="toast.type === 'error'" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>{{ toast.msg }}</span>
                </div>
            </transition-group>
        </div>

        <!-- 左侧导航面板遮罩层 -->
        <div v-if="!isSidebarCollapsed" 
             class="fixed inset-0 z-[55] bg-black bg-opacity-50 touch-none md:hidden"
             @click.self="closeSidebar">
        </div>

        <!-- 左侧导航面板 -->
        <aside :class="[
            'fixed left-0 top-0 bottom-0 z-[60] border-r transition-transform duration-300 ease-in-out overflow-hidden sidebar-glass',
            isSidebarCollapsed ? '-translate-x-full' : 'translate-x-0',
            borderClass
        ]" style="width: 256px;">
            <div class="h-full flex flex-col p-4">
                <!-- 关闭按钮 (移动端显示) -->
                <button 
                    @click="closeSidebar"
                    :class="['absolute top-2 right-2 p-1 rounded-full md:hidden', hoverBgClass + ' text-gray-500']"
                    aria-label="关闭菜单"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <!-- 品牌标识 -->
                <div class="mb-8 pt-4 flex items-center justify-center">
                    <h1 
                        class="text-xl font-bold tracking-wider" 
                        :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }"
                    >
                        每日一文
                    </h1>
                    <p 
                        class="text-xs opacity-60 mt-1"
                    >
                        {{ currentDate }}
                    </p>
                </div>
                
                <!-- 导航菜单 -->
                <nav class="flex-1 overflow-y-auto">
                    <ul class="space-y-2">
                          <li>
                              <button 
                                  @click="activeTab = 'daily'; isSidebarCollapsed = true"
                                  :class="[
                                      'group flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 relative overflow-hidden',
                                      activeTab === 'daily' 
                                          ? (backgroundColor === 'dark' ? 'bg-blue-600/20 text-blue-400 shadow-[inset_0_0_20px_rgba(59,130,246,0.1)]' : 'bg-blue-50 text-blue-600 shadow-sm') 
                                          : (backgroundColor === 'dark' ? 'hover:bg-gray-800/50 text-gray-400' : 'hover:bg-gray-50 text-gray-600')
                                  ]"
                              >
                                  <div :class="['absolute left-0 top-0 bottom-0 w-1 bg-blue-500 transition-transform duration-300', activeTab === 'daily' ? 'scale-y-100' : 'scale-y-0']"></div>
                                  <svg xmlns="http://www.w3.org/2000/svg" :class="['h-5 w-5 transition-transform duration-300', activeTab === 'daily' ? 'scale-110' : 'group-hover:scale-110']" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                  </svg>
                                  <span class="font-medium">每日一文</span>
                              </button>
                           </li>

                           <li>
                                <button 
                                    @click="activeTab = 'favorites'; isSidebarCollapsed = true"
                                    :class="[
                                        'group flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 relative overflow-hidden',
                                        activeTab === 'favorites' 
                                            ? (backgroundColor === 'dark' ? 'bg-red-600/20 text-red-400 shadow-[inset_0_0_20px_rgba(239,68,68,0.1)]' : 'bg-red-50 text-red-600 shadow-sm') 
                                            : (backgroundColor === 'dark' ? 'hover:bg-gray-800/50 text-gray-400' : 'hover:bg-gray-50 text-gray-600')
                                    ]"
                                >
                                    <div :class="['absolute left-0 top-0 bottom-0 w-1 bg-red-500 transition-transform duration-300', activeTab === 'favorites' ? 'scale-y-100' : 'scale-y-0']"></div>
                                    <svg xmlns="http://www.w3.org/2000/svg" :class="['h-5 w-5 transition-transform duration-300', activeTab === 'favorites' ? 'scale-110' : 'group-hover:scale-110']" :fill="activeTab === 'favorites' ? 'currentColor' : 'none'" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                    </svg>
                                    <span class="font-medium">收藏文章</span>
                                    <span
                                        v-if="favoriteArticles.length > 0"
                                        :class="['ml-auto text-[10px] font-bold rounded-full px-2 py-0.5', activeTab === 'favorites' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-600']"
                                    >
                                        {{ favoriteArticles.length }}
                                    </span>
                                 </button>
                             </li>

                          <!-- 上传中心（可展开菜单） -->
                          <li>
                             <div class="space-y-1">
                                 <button 
                                     @click="toggleUploadMenu"
                                     :class="[
                                         'group flex items-center justify-between w-full px-4 py-3 rounded-xl transition-all duration-300 relative overflow-hidden',
                                         (activeTab === 'upload-file' || activeTab === 'upload-folder' || activeTab === 'upload-list')
                                             ? (backgroundColor === 'dark' ? 'bg-blue-600/20 text-blue-400 shadow-[inset_0_0_20px_rgba(59,130,246,0.1)]' : 'bg-blue-50 text-blue-600 shadow-sm') 
                                             : (backgroundColor === 'dark' ? 'hover:bg-gray-800/50 text-gray-400' : 'hover:bg-gray-50 text-gray-600')
                                     ]"
                                 >
                                     <div v-if="activeTab === 'upload-file' || activeTab === 'upload-folder' || activeTab === 'upload-list'" class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                                     <div class="flex items-center gap-3 nav-item-content">
                                         <svg xmlns="http://www.w3.org/2000/svg" :class="['h-5 w-5 transition-transform duration-300', isUploadMenuOpen ? 'scale-110' : 'group-hover:scale-110']" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                         </svg>
                                         <span class="font-medium">上传中心</span>
                                     </div>
                                     <svg 
                                         xmlns="http://www.w3.org/2000/svg" 
                                         :class="['h-4 w-4 transition-transform duration-300', isUploadMenuOpen ? 'rotate-180' : '']" 
                                         fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                     >
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                     </svg>
                                 </button>

                                 <!-- 子菜单 -->
                                 <transition name="toast">
                                    <ul v-show="isUploadMenuOpen" class="mt-1 space-y-1 ml-6 pl-4 border-l-2 border-gray-100 dark:border-gray-800">
                                        <li>
                                            <button 
                                                @click="handleUploadOption('upload-file')"
                                                :class="[
                                                    'flex items-center gap-2 w-full px-3 py-2 rounded-lg text-sm transition-all',
                                                    activeTab === 'upload-file' 
                                                        ? 'text-blue-500 font-semibold'
                                                        : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-200'
                                                ]"
                                            >
                                                <span>上传文件</span>
                                            </button>
                                        </li>
                                        <li>
                                            <button 
                                                @click="handleUploadOption('upload-folder')"
                                                :class="[
                                                    'flex items-center gap-2 w-full px-3 py-2 rounded-lg text-sm transition-all',
                                                    activeTab === 'upload-folder'
                                                        ? 'text-blue-500 font-semibold'
                                                        : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-200'
                                                ]"
                                            >
                                                <span>上传文件夹</span>
                                            </button>
                                        </li>
                                        <li>
                                            <button 
                                                @click="handleUploadOption('upload-list')"
                                                :class="[
                                                    'flex items-center gap-2 w-full px-3 py-2 rounded-lg text-sm transition-all',
                                                    activeTab === 'upload-list'
                                                        ? 'text-blue-500 font-semibold'
                                                        : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-200'
                                                ]"
                                            >
                                                <span>上传列表</span>
                                                <span 
                                                    v-if="uploadedArticles.length > 0"
                                                    class="ml-auto text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full font-bold"
                                                >
                                                    {{ uploadedArticles.length }}
                                                </span>
                                             </button>
                                         </li>
                                     </ul>
                                  </div>
                           </li>

                           <!-- 个人信息入口 -->
                           <li v-if="user">
                               <button
                                   @click="activeTab = 'profile'; isSidebarCollapsed = true"
                                   :class="[
                                       'group flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 relative overflow-hidden',
                                       activeTab === 'profile'
                                           ? (backgroundColor === 'dark' ? 'bg-blue-600/20 text-blue-400 shadow-[inset_0_0_20px_rgba(59,130,246,0.1)]' : 'bg-blue-50 text-blue-600 shadow-sm') 
                                           : (backgroundColor === 'dark' ? 'hover:bg-gray-800/50 text-gray-400' : 'hover:bg-gray-100 text-gray-600')
                                   ]"
                               >
                                   <div :class="['absolute left-0 top-0 bottom-0 w-1 bg-blue-500 transition-transform duration-300', activeTab === 'profile' ? 'scale-y-100' : 'scale-y-0']"></div>
                                   <svg xmlns="http://www.w3.org/2000/svg" :class="['h-5 w-5 transition-transform duration-300', activeTab === 'profile' ? 'scale-110' : 'group-hover:scale-110']" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                   </svg>
                                   <span class="font-medium">个人信息</span>
                               </button>
                           </li>

                           <!-- 用户管理入口 (仅 admin 可见) -->
                          <li v-if="user && user.username === 'admin'">
                              <button
                                  @click="activeTab = 'admin'; isSidebarCollapsed = true"
                                  :class="[
                                      'group flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 relative overflow-hidden',
                                      activeTab === 'admin'
                                          ? (backgroundColor === 'dark' ? 'bg-purple-600/20 text-purple-400 shadow-[inset_0_0_20px_rgba(168,85,247,0.1)]' : 'bg-purple-50 text-purple-600 shadow-sm') 
                                          : (backgroundColor === 'dark' ? 'hover:bg-gray-800/50 text-gray-400' : 'hover:bg-gray-100 text-gray-600')
                                  ]"
                              >
                                  <div :class="['absolute left-0 top-0 bottom-0 w-1 bg-purple-500 transition-transform duration-300', activeTab === 'admin' ? 'scale-y-100' : 'scale-y-0']"></div>
                                  <svg xmlns="http://www.w3.org/2000/svg" :class="['h-5 w-5 transition-transform duration-300', activeTab === 'admin' ? 'scale-110' : 'group-hover:scale-110']" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                  </svg>
                                  <span class="font-medium">用户管理</span>
                              </button>
                          </li>

                          <!-- 关于 -->
                          <li>
                              <button
                                  @click="activeTab = 'about'; isSidebarCollapsed = true"
                                  :class="[
                                      'group flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 relative overflow-hidden',
                                      activeTab === 'about'
                                          ? (backgroundColor === 'dark' ? 'bg-emerald-600/20 text-emerald-400 shadow-[inset_0_0_20px_rgba(16,185,129,0.1)]' : 'bg-emerald-50 text-emerald-600 shadow-sm')
                                          : (backgroundColor === 'dark' ? 'hover:bg-gray-800/50 text-gray-400' : 'hover:bg-gray-100 text-gray-600')
                                  ]"
                              >
                                  <div :class="['absolute left-0 top-0 bottom-0 w-1 bg-emerald-500 transition-transform duration-300', activeTab === 'about' ? 'scale-y-100' : 'scale-y-0']"></div>
                                  <svg xmlns="http://www.w3.org/2000/svg" :class="['h-5 w-5 transition-transform duration-300', activeTab === 'about' ? 'scale-110' : 'group-hover:scale-110']" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                  <span class="font-medium">关于</span>
                              </button>
                          </li>
                       </ul>
                   </nav>
                
                <!-- 底部信息 -->
                <div class="mt-8 pb-4 text-center">
                    <p class="text-[10px] opacity-40">Content provided by qhsou.com</p>
                </div>
            </div>
        </aside>
        
        <!-- 右侧内容区域 -->
        <div :class="['flex-1 flex flex-col overflow-hidden transition-all duration-300', isSidebarCollapsed ? 'ml-0' : 'md:ml-64 ml-0']" style="padding-top: 4rem;">
            <!-- 顶部操作栏 -->
            <header :class="['fixed top-0 left-0 right-0 z-50 py-2 px-3 md:py-4 md:px-6 flex justify-between items-center border-b transition-colors duration-300', borderClass + ' ' + bgClass, isSidebarCollapsed ? '' : 'md:ml-64']">
                <!-- 阅读进度条 -->
                <div v-if="activeTab === 'daily' && article" class="reading-progress-bar" :style="{ width: readingProgress + '%' }"></div>
                
                <!-- 左侧：菜单按钮和标题放在同一行 -->
                <div class="flex items-center overflow-hidden">
                    <!-- 菜单按钮（侧边栏关闭时显示） -->
                    <button 
                        v-if="isSidebarCollapsed"
                        @click="openSidebar"
                        :class="['p-2 rounded transition-colors mr-2 flex-shrink-0', hoverBgClass + ' text-gray-600']"
                        aria-label="打开菜单"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    
                    <h2 class="text-base md:text-lg font-semibold truncate" :style="{ color: textClass }">
                        {{ getPageTitle() }}
                    </h2>
                </div>
                <div class="flex items-center gap-1 md:gap-2 flex-shrink-0 ml-2">
                    <!-- 登录/注册按钮 (未登录时显示) -->
                    <template v-if="!user">
                        <button 
                            @click="openAuth('login')"
                            :class="['px-2 py-1.5 md:px-3 md:py-1.5 rounded text-xs md:text-sm font-medium transition-colors', isDark ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']"
                        >
                            登录
                        </button>
                    </template>
                    
                    <!-- 已登录显示用户名 (移动端缩减显示或隐藏) -->
                    <template v-else>
                        <span :class="['hidden sm:inline text-sm mr-1 md:mr-2', textClass]">
                            {{ user.username }}
                        </span>
                    </template>
                    
                    <!-- 设置按钮 -->
                    <button 
                        ref="settingsButtonRef"
                        @click="toggleSettings"
                        :class="['p-2 rounded-full transition-colors', hoverBgClass]"
                        aria-label="设置"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    
                    <!-- 换一篇按钮 (仅在每日一文页面显示) -->
                    <button 
                        v-if="activeTab === 'daily'"
                        @click="getArticle" 
                        :disabled="loading"
                        :class="[
                            'group flex items-center gap-1 md:gap-2 px-2 py-2 md:px-4 md:py-2 rounded-full shadow-sm transition-all active:scale-95 disabled:opacity-50 border',
                            backgroundColor === 'dark' 
                                ? 'bg-gray-800 border-gray-700 hover:bg-gray-700' 
                                : 'bg-white border-gray-200 hover:shadow-md'
                        ]"
                        :title="'换一篇'"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                         <span class="hidden md:inline text-sm font-medium">换一篇</span>
                     </button>

                     <!-- 收藏按钮 -->
                     <button
                         v-if="article"
                         @click="toggleFavorite"
                         :class="[
                             'p-2 rounded-full transition-colors',
                             isFavorited ? 'text-red-500' : (backgroundColor === 'dark' ? 'hover:bg-gray-800' : 'hover:bg-gray-100')
                         ]"
                         :title="isFavorited ? '取消收藏' : '收藏文章'"
                     >
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" :fill="isFavorited ? 'currentColor' : 'none'" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                         </svg>
                     </button>
                  </div>
             </header>

            <!-- 登录/注册弹窗 -->
            <transition name="toast">
                <div v-if="showAuth" class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" @click.self="showAuth = false">
                    <div :class="['w-full max-w-md rounded-3xl shadow-2xl overflow-hidden glass-panel border transition-all duration-300', backgroundColor === 'dark' ? 'bg-gray-900/80 border-gray-700' : 'bg-white/90 border-white']">
                        <!-- 弹窗头部 -->
                        <div class="p-6 pb-0 flex justify-between items-center">
                            <div class="flex flex-col">
                                <h3 :class="['text-xl font-bold tracking-tight', backgroundColor === 'dark' ? 'text-white' : 'text-gray-800']">
                                    {{ authMode === 'login' ? '欢迎回来' : '开启阅读之旅' }}
                                </h3>
                                <p class="text-xs opacity-50 mt-1">
                                    {{ authMode === 'login' ? '请登录您的账号' : '创建一个新账号以保存收藏' }}
                                </p>
                            </div>
                            <button @click="showAuth = false" :class="['p-2 rounded-full hover:bg-black/10 transition-colors', backgroundColor === 'dark' ? 'text-gray-400 hover:text-white' : 'text-gray-400']">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- 模式切换 Tab -->
                        <div class="p-6 pb-4">
                            <div :class="['flex p-1 rounded-xl relative', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-gray-100']">
                                <!-- 滑动背景 -->
                                <div 
                                    class="absolute top-1 bottom-1 w-[calc(50%-4px)] rounded-lg transition-all duration-300 ease-out z-0"
                                    :style="{ transform: authMode === 'login' ? 'translateX(0)' : 'translateX(calc(100% + 4px))' }"
                                    :class="[backgroundColor === 'dark' ? 'bg-gray-700' : 'bg-white shadow-sm']"
                                ></div>
                                <button 
                                    @click="authMode = 'login'"
                                    class="flex-1 py-2 text-sm font-semibold transition-all relative z-10"
                                    :class="[authMode === 'login' ? (backgroundColor === 'dark' ? 'text-white' : 'text-blue-600') : 'text-gray-400']"
                                >
                                    登录
                                </button>
                                <button 
                                    @click="authMode = 'register'"
                                    class="flex-1 py-2 text-sm font-semibold transition-all relative z-10"
                                    :class="[authMode === 'register' ? (backgroundColor === 'dark' ? 'text-white' : 'text-green-600') : 'text-gray-400']"
                                >
                                    注册
                                </button>
                            </div>
                        </div>
                        
                        <!-- 表单主体 -->
                        <div class="p-6 pt-0 relative min-h-[280px]">
                            <transition name="auth-slide" mode="out-in">
                                <!-- 登录表单 -->
                                <div v-if="authMode === 'login'" key="login" class="space-y-4">
                                    <input 
                                        v-model="loginForm.username"
                                        type="text"
                                        placeholder="您的用户名"
                                        class="input-zen w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                        :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                    />
                                    <input 
                                        v-model="loginForm.password"
                                        type="password"
                                        placeholder="输入密码"
                                        @keyup.enter="doLogin"
                                        class="input-zen w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                        :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                    />
<div class="flex gap-2">
                                        <input 
                                            v-model="loginForm.captcha"
                                            type="text"
                                            placeholder="验证码"
                                            maxlength="4"
                                            @keyup.enter="doLogin"
                                            class="input-zen flex-1 min-w-0 px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                            :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                        />
                                        <div class="relative group cursor-pointer flex-shrink-0" @click="refreshCaptcha">
                                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 rounded-xl transition-all flex items-center justify-center overflow-hidden z-10">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 opacity-0 group-hover:opacity-100 rotate-0 group-hover:rotate-180 transition-all duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                            </div>
                                            <img v-if="captchaImage" :src="captchaImage" class="w-32 h-11 sm:w-44 sm:h-14 rounded-xl border-2 object-cover shadow-sm" :class="backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-200'" />
                                            <div v-else class="w-32 h-11 sm:w-44 sm:h-14 rounded-xl border flex items-center justify-center animate-pulse" :class="backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-gray-100 border-gray-200'">
                                                <div class="h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <button @click="doLogin" class="w-full py-3.5 rounded-xl text-sm font-bold text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 shadow-lg shadow-blue-500/30 transition-all active:scale-[0.98]">
                                        立即登录
                                    </button>
                                    <div class="text-center mt-3">
                                        <button 
                                            @click="openForgotPassword"
                                            :class="['text-sm hover:underline', backgroundColor === 'dark' ? 'text-blue-400 hover:text-blue-300' : 'text-blue-500 hover:text-blue-600']"
                                        >
                                            忘记密码？
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 注册表单 -->
                                <div v-else key="register" class="space-y-4">
                                <input 
                                    v-model="regForm.username"
                                    type="text"
                                    placeholder="设置用户名"
                                    class="input-zen w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                    :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                />
                                <input 
                                    v-model="regForm.email"
                                    type="email"
                                    placeholder="邮箱地址"
                                    @keyup.enter="doRegister"
                                    class="input-zen w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                    :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                />
                                <input 
                                    v-model="regForm.password"
                                    type="password"
                                    placeholder="设置登录密码"
                                    @keyup.enter="doRegister"
                                    class="input-zen w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                    :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                />
                                <input 
                                    v-model="regForm.confirm_password"
                                    type="password"
                                    placeholder="确认密码"
                                    @keyup.enter="doRegister"
                                    class="input-zen w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                    :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                />
<div class="flex gap-2">
                                <input 
                                    v-model="regForm.captcha"
                                    type="text"
                                    placeholder="验证码"
                                    maxlength="4"
                                    @keyup.enter="doRegister"
                                    class="input-zen flex-1 min-w-0 px-4 py-3 rounded-xl border text-sm transition-all shadow-inner"
                                    :class="[backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                />
                                        <div class="relative group cursor-pointer flex-shrink-0" @click="refreshCaptcha">
                                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 rounded-xl transition-all flex items-center justify-center overflow-hidden z-10">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 opacity-0 group-hover:opacity-100 rotate-0 group-hover:rotate-180 transition-all duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                            </div>
                                            <img v-if="captchaImage" :src="captchaImage" class="w-32 h-11 sm:w-44 sm:h-14 rounded-xl border-2 object-cover shadow-sm" :class="backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-200'" />
                                            <div v-else class="w-32 h-11 sm:w-44 sm:h-14 rounded-xl border flex items-center justify-center animate-pulse" :class="backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-gray-100 border-gray-200'">
                                                <div class="h-4 w-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <button @click="doRegister" class="w-full py-3.5 rounded-xl text-sm font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 shadow-lg shadow-green-500/30 transition-all active:scale-[0.98]">
                                        创建账号
                                    </button>
                                </div>
                            </transition>
                        </div>
                    </div>
                </div>
            </transition>
            
            <!-- 忘记密码弹窗 -->
            <transition name="toast">
                <div v-if="showForgotPassword" class="fixed inset-0 z-[75] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" @click.self="showForgotPassword = false">
                    <div :class="['w-full max-w-md rounded-3xl shadow-2xl overflow-hidden glass-panel border transition-all duration-300', backgroundColor === 'dark' ? 'bg-gray-900/80 border-gray-700' : 'bg-white/90 border-white']">
                        <div class="p-6 pb-0 flex justify-between items-center">
                            <div class="flex flex-col">
                                <h3 :class="['text-xl font-bold tracking-tight', backgroundColor === 'dark' ? 'text-white' : 'text-gray-800']">
                                    找回密码
                                </h3>
                                <p class="text-xs opacity-50 mt-1">
                                    通过邮箱验证码重置密码
                                </p>
                            </div>
                            <button @click="showForgotPassword = false" :class="['p-2 rounded-full hover:bg-black/10 transition-colors', backgroundColor === 'dark' ? 'text-gray-400 hover:text-white' : 'text-gray-400']">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <div class="p-6">
                            <!-- SMTP 未配置时的提示 -->
                            <div v-if="!smtpEnabled" class="text-center py-6">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <p :class="['text-sm mb-2', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']">邮件服务未启用</p>
                                <p :class="['text-xs opacity-60', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">
                                    请联系管理员重置密码
                                </p>
                                <p v-if="smtpInfo.admin_email" :class="['text-xs mt-2', backgroundColor === 'dark' ? 'text-blue-400' : 'text-blue-500']">
                                    管理员邮箱: {{ smtpInfo.admin_email }}
                                </p>
                            </div>
                            
                            <!-- SMTP 已配置时的表单 -->
                            <div v-else>
                                <!-- 步骤1: 输入邮箱 -->
                                <div v-if="forgotStep === 1">
                                    <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">注册邮箱</label>
                                    <input 
                                        v-model="forgotEmail"
                                        type="email"
                                        placeholder="请输入注册时使用的邮箱"
                                        :class="['w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner', backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                    />
                                    <button 
                                        @click="sendResetCode"
                                        :disabled="!forgotEmail || sendingCode"
                                        :class="['w-full mt-4 py-3 rounded-xl text-sm font-bold text-white transition-all', (!forgotEmail || sendingCode) ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 shadow-lg shadow-blue-500/30 active:scale-[0.98]']"
                                    >
                                        {{ sendingCode ? '发送中...' : '发送验证码' }}
                                    </button>
                                </div>
                                
                                <!-- 步骤2: 输入验证码和新密码 -->
                                <div v-else-if="forgotStep === 2">
                                    <div class="text-center mb-4">
                                        <p :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']">
                                            验证码已发送至 <span :class="['font-medium', backgroundColor === 'dark' ? 'text-blue-400' : 'text-blue-500']">{{ forgotEmail }}</span>
                                        </p>
                                    </div>
                                    <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">验证码</label>
                                    <input 
                                        v-model="forgotCode"
                                        type="text"
                                        maxlength="6"
                                        placeholder="请输入6位验证码"
                                        :class="['w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner', backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                    />
                                    <label :class="['block text-sm font-medium mb-1 mt-3', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">新密码</label>
                                    <input 
                                        v-model="forgotNewPassword"
                                        type="password"
                                        placeholder="请设置新密码 (至少6位)"
                                        :class="['w-full px-4 py-3 rounded-xl border text-sm transition-all shadow-inner', backgroundColor === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']"
                                    />
                                    <div class="flex gap-2 mt-4">
                                        <button 
                                            @click="forgotStep = 1"
                                            :class="['flex-1 py-3 rounded-xl text-sm font-medium border transition-colors', backgroundColor === 'dark' ? 'border-gray-600 text-gray-300 hover:bg-gray-800' : 'border-gray-300 text-gray-700 hover:bg-gray-50']"
                                        >
                                            返回
                                        </button>
                                        <button 
                                            @click="resetPassword"
                                            :disabled="!forgotCode || !forgotNewPassword || forgotNewPassword.length < 6 || resettingPassword"
                                            :class="['flex-1 py-3 rounded-xl text-sm font-bold text-white transition-all', (!forgotCode || !forgotNewPassword || forgotNewPassword.length < 6 || resettingPassword) ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 shadow-lg shadow-green-500/30 active:scale-[0.98]']"
                                        >
                                            {{ resettingPassword ? '重置中...' : '重置密码' }}
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 步骤3: 成功 -->
                                <div v-else-if="forgotStep === 3" class="text-center py-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <p :class="['text-lg font-medium mb-2', backgroundColor === 'dark' ? 'text-white' : 'text-gray-800']">密码重置成功！</p>
                                    <p :class="['text-sm opacity-60 mb-4', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">请使用新密码登录</p>
                                    <button 
                                        @click="closeForgotPassword"
                                        :class="['px-6 py-2 rounded-xl text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 transition-colors']"
                                    >
                                        去登录
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 主内容区 -->
            <main class="flex-1 overflow-hidden relative">
                <!-- 每日一文内容 -->
                <div v-if="activeTab === 'daily'" class="h-full overflow-hidden relative">
                    <!-- 加载状态 -->
                    <div v-if="loading" :class="['absolute inset-0 flex flex-col justify-center items-center rounded-2xl shadow-sm z-10 transition-colors duration-300']" :style="{ backgroundColor: bgColors[backgroundColor].bg }">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2" :style="{ borderColor: bgColors[backgroundColor].text }" class="mb-4"></div>
                        <p :style="{ color: bgColors[backgroundColor].text }" class="text-sm tracking-widest opacity-70">正在寻找好文章...</p>
                    </div>

                    <!-- 骨架屏 -->
                    <div v-else-if="!article" :class="['absolute inset-0 rounded-2xl shadow-sm z-10 p-8 transition-colors duration-300']" :style="{ backgroundColor: bgColors[backgroundColor].bg }">
                        <div class="max-w-prose mx-auto space-y-8">
                            <div class="animate-pulse space-y-4">
                                <div class="h-8 bg-gray-200 rounded w-3/4 mx-auto"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/4 mx-auto"></div>
                            </div>
                            <div class="animate-pulse space-y-4">
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                            </div>
                            <div class="animate-pulse space-y-4">
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 错误状态 -->
                    <div v-if="error" :class="['absolute inset-0 flex flex-col justify-center items-center rounded-2xl shadow-sm z-10 p-8 text-center transition-colors duration-300']" :style="{ backgroundColor: bgColors[backgroundColor].bg }">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <p :style="{ color: bgColors[backgroundColor].text }" class="mb-4 max-w-md">{{ error }}</p>
                        <button @click="getArticle" class="px-6 py-2 bg-gray-800 text-white text-sm rounded-lg hover:bg-gray-700 transition">重试</button>
                    </div>

                    <!-- 文章卡片 -->
                    <article v-if="article" @scroll="handleArticleScroll" :class="['h-full w-full overflow-y-auto p-6 md:p-10 transition-opacity duration-500 opacity-100 transition-colors duration-300']" :style="{ backgroundColor: bgColors[backgroundColor].bg, color: bgColors[backgroundColor].text }">
                        <div class="max-w-3xl mx-auto">
                            <!-- 标题 -->
                            <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 leading-tight">
                                {{ article.title }}
                            </h2>
                            
                            <!-- 作者和阅读信息 -->
                            <div class="text-center mb-10">
                                <div class="flex items-center justify-center gap-4">
                                    <span class="inline-block h-px w-8" :style="{ backgroundColor: bgColors[backgroundColor].text }" class="align-middle opacity-30"></span>
                                    <span class="text-sm mx-2 tracking-widest opacity-70">{{ article.author || '佚名' }}</span>
                                    <span class="inline-block h-px w-8" :style="{ backgroundColor: bgColors[backgroundColor].text }" class="align-middle opacity-30"></span>
                                    <span class="inline-block h-px w-8" :style="{ backgroundColor: bgColors[backgroundColor].text }" class="align-middle opacity-30"></span>
                                    <span class="text-xs flex items-center gap-1 opacity-70">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        {{ readingTime }} 分钟阅读
                                    </span>
                                    <span class="inline-block h-px w-8" :style="{ backgroundColor: bgColors[backgroundColor].text }" class="align-middle opacity-30"></span>
                                </div>
                            </div>

                             <!-- 正文 -->
                             <div :class="['prose prose-lg text-justify prose-p:indent-8 prose-p:leading-loose mx-auto font-serif-reading', bgColors[backgroundColor].prose]" v-html="article.content" :style="{ fontSize: fontSize + 'px' }">
                             </div>
                            
                            <!-- 底部结束符 -->
                            <div class="mt-16 text-center">
                                <span :style="{ color: bgColors[backgroundColor].text }" class="opacity-40 text-xl">❦</span>
                            </div>
                        </div>
                    </article>
                </div>

                 <!-- 上传列表 -->
                 <div v-else-if="activeTab === 'upload-list'" class="h-full overflow-y-auto p-6">
                     <div class="max-w-3xl mx-auto">
                         <!-- 上传的文章列表（从数据库） -->
                         <div v-if="uploadedArticles.length > 0" class="mb-6">
                             <div class="flex justify-between items-center mb-3">
                                 <h3 :class="['text-lg font-semibold', textClass]">上传的文章</h3>
                                 <div class="flex gap-2">
                                     <button 
                                         @click="downloadUploadedZip"
                                         :class="['px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1', backgroundColor === 'dark' ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']"
                                     >
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                         </svg>
                                         批量下载
                                     </button>
                                     <button 
                                         @click="addAllToFavorites"
                                         :class="['px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1', backgroundColor === 'dark' ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white']"
                                     >
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                         </svg>
                                         一键收藏全部
                                     </button>
                                 </div>
                              </div>
                              <button 
                                  @click="clearUploaded"
                                  :class="['px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1', backgroundColor === 'dark' ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white']"
                              >
                                  清空上传列表
                              </button>
                              <div class="space-y-3">
                                 <div 
                                     v-for="item in uploadedArticles" 
                                     :key="item.id"
                                     @click="viewLocalArticle(item)"
                                     :class="['p-4 rounded-xl shadow-sm transition-all cursor-pointer', cardBgClass + ' ' + borderClass]"
                                 >
                                     <h3 class="text-lg font-semibold mb-1">{{ item.title }}</h3>
                                     <p class="text-sm opacity-60 mb-2">{{ item.author || '佚名' }}</p>
                                     <div class="flex justify-between items-center">
                                         <div class="flex flex-col">
                                             <span class="text-xs opacity-40">{{ item.file_name || '本地文件' }}</span>
                                             <span class="text-xs opacity-40">{{ new Date(item.date_added).toLocaleDateString() }}</span>
                                         </div>
                                         <div class="flex items-center gap-2">
                                             <button @click.stop="addToFavorites(item)" 
                                                 :class="[
                                                     'p-1 rounded transition-colors',
                                                     isItemFavorited(item) ? 'text-red-500' : 'text-gray-400 hover:text-red-500'
                                                 ]" 
                                                 :title="isItemFavorited(item) ? '已收藏' : '收藏文章'"
                                             >
                                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" :fill="isItemFavorited(item) ? 'currentColor' : 'none'" viewBox="0 0 24 24" stroke="currentColor">
                                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                                 </svg>
                                             </button>
                                             <button @click.stop="downloadUploadedArticle(item)" class="text-blue-500 hover:text-blue-700 p-1 rounded transition-colors" title="下载文章">
                                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                                 </svg>
                                             </button>
                                             <button @click.stop="deleteUploadedArticle(item.id)" class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="删除文章">
                                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                 </svg>
                                              </button>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>

                         <!-- 本次选择的本地文件 -->
                         <div v-if="localArticles.length > 0">
                             <h3 :class="['text-lg font-semibold mb-3', textClass]">本次选择的文件</h3>
                             <div class="space-y-3">
                                 <div 
                                     v-for="(item, index) in localArticles" 
                                     :key="item.id || index"
                                     @click="viewLocalArticle(item)"
                                     :class="['p-4 rounded-xl shadow-sm transition-all cursor-pointer', cardBgClass + ' ' + borderClass]"
                                 >
                                     <h3 class="text-lg font-semibold mb-1">{{ item.title }}</h3>
                                     <p class="text-sm opacity-60 mb-2">{{ item.author || '佚名' }}</p>
                                     <div class="flex justify-between items-center">
                                         <div class="flex flex-col">
                                             <span class="text-xs opacity-40">{{ item.fileName }}</span>
                                             <span class="text-xs opacity-40">{{ (item.fileSize / 1024).toFixed(1) }}KB</span>
                                         </div>
                                         <button @click.stop="downloadLocalArticle(item)" class="text-blue-500 hover:text-blue-700 p-1 rounded transition-colors" title="下载文章">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                             </svg>
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>

                         <div v-if="localArticles.length === 0 && uploadedArticles.length === 0" class="text-center py-12">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                             </svg>
                             <p class="text-lg opacity-60">暂无上传的文章</p>
                             <p class="text-sm opacity-40 mt-2">点击"上传文件"或"上传文件夹"按钮上传文章</p>
                         </div>
                     </div>
                  </div>

                   <!-- 收藏文章列表 -->
                   <div v-else-if="activeTab === 'favorites'" class="h-full overflow-y-auto p-6">
                       <div class="max-w-3xl mx-auto">
                           <!-- 批量操作按钮 -->
                           <div v-if="favoriteArticles.length > 0" class="mb-4 flex justify-end">
                               <button 
                                   @click="downloadFavoritesZip"
                                   :class="['px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2', backgroundColor === 'dark' ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']"
                               >
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                   </svg>
                                   批量下载全部
                               </button>
                           </div>
                           <div v-if="favoriteArticles.length === 0" class="text-center py-12">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                               </svg>
                               <p class="text-lg opacity-60">暂无收藏文章</p>
                               <p class="text-sm opacity-40 mt-2">阅读文章时点击心形图标收藏</p>
                           </div>
                          <div v-else class="space-y-4">
                              <div
                                  v-for="(item, index) in favoriteArticles"
                                  :key="item.id || index"
                                  @click="viewLocalArticle(item)"
                                  :class="['p-4 rounded-xl shadow-sm transition-all cursor-pointer', cardBgClass + ' ' + borderClass]"
                              >
                                  <h3 class="text-lg font-semibold mb-1">{{ item.title }}</h3>
                                  <p class="text-sm opacity-60 mb-2">{{ item.author || '佚名' }}</p>
                                  <div class="flex justify-between items-center">
                                      <span class="text-xs opacity-40">{{ new Date(item.dateAdded).toLocaleDateString() }}</span>
                                      <div class="flex items-center gap-2">
                                          <button @click.stop="downloadFavorite(item)" class="text-blue-500 hover:text-blue-700 p-1 rounded transition-colors" title="下载文章">
                                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                              </svg>
                                          </button>
                                          <button @click.stop="removeFavorite(item.id)" class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="移除收藏">
                                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                  </svg>
                                               </button>
                                       </div>
                                   </div>
                               </div>
                            </div>
                        </div>
                    </div>

                    <!-- 个人信息页面 -->
                    <div v-else-if="activeTab === 'profile'" class="h-full overflow-y-auto p-6">
                        <div class="max-w-2xl mx-auto">
                            <div :class="['rounded-lg p-6 mb-6', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                                <div class="flex items-center gap-4 mb-6">
                                    <div :class="['w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold', backgroundColor === 'dark' ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-600']">
                                        {{ user?.username?.charAt(0).toUpperCase() }}
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">
                                            {{ user?.username }}
                                        </h2>
                                        <p :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">
                                            ID: {{ user?.id }}
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div :class="['flex justify-between items-center p-4 rounded-lg', backgroundColor === 'dark' ? 'bg-gray-700' : 'bg-gray-50']">
                                        <div>
                                            <p :class="['text-sm font-medium', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">用户名</p>
                                            <p :class="['text-lg', backgroundColor === 'dark' ? 'text-white' : 'text-gray-900']">{{ user?.username }}</p>
                                        </div>
                                        <button
                                            @click="openChangeUsername"
                                            :class="['px-3 py-1.5 rounded text-sm font-medium transition-colors', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']"
                                        >
                                            修改
                                        </button>
                                    </div>

                                    <div :class="['flex justify-between items-center p-4 rounded-lg', backgroundColor === 'dark' ? 'bg-gray-700' : 'bg-gray-50']">
                                        <div>
                                            <p :class="['text-sm font-medium', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">邮箱地址</p>
                                            <p :class="['text-lg', backgroundColor === 'dark' ? 'text-white' : 'text-gray-900']">
                                                {{ user?.email || '未设置' }}
                                            </p>
                                        </div>
                                        <button 
                                            @click="openChangeEmail"
                                            :class="['px-3 py-1.5 rounded text-sm font-medium transition-colors', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']"
                                        >
                                            修改
                                        </button>
                                    </div>
                                    
                                    <div :class="['flex justify-between items-center p-4 rounded-lg', backgroundColor === 'dark' ? 'bg-gray-700' : 'bg-gray-50']">
                                        <div>
                                            <p :class="['text-sm font-medium', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">密码</p>
                                            <p :class="['text-lg', backgroundColor === 'dark' ? 'text-white' : 'text-gray-900']">••••••••</p>
                                        </div>
                                        <button 
                                            @click="openChangePassword"
                                            :class="['px-3 py-1.5 rounded text-sm font-medium transition-colors', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']"
                                        >
                                            修改
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div :class="['rounded-lg p-6', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                                <h3 class="text-lg font-semibold mb-4" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">账户操作</h3>
                                <button 
                                    @click="doLogout"
                                    :class="['w-full py-3 rounded-lg text-sm font-medium transition-colors', backgroundColor === 'dark' ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-red-500 hover:bg-red-600 text-white']"
                                >
                                    退出登录
                                </button>
                            </div>
                        </div>
                    </div>

                       <!-- 用户管理页面 (仅 admin 可见) -->
                      <div v-else-if="activeTab === 'admin'" class="h-full overflow-y-auto p-6">
                      <div class="max-w-4xl mx-auto">
                          <div v-if="loadingUsers" class="text-center py-12">
                              <div class="animate-spin rounded-full h-8 w-8 border-b-2 mx-auto mb-4" :style="{ borderColor: backgroundColor === 'dark' ? '#9ca3af' : '#6b7280' }"></div>
                              <p :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">加载中...</p>
                          </div>
                          <div v-else-if="!user || user.username !== 'admin'" class="text-center py-12">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                              </svg>
                              <p class="text-lg opacity-60">权限不足</p>
                              <p class="text-sm opacity-40 mt-2">只有管理员可以访问此页面</p>
                          </div>
                          <div v-else>
                              <div :class="['flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 p-4 rounded-lg', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                                  <div>
                                      <h3 class="text-lg font-semibold" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">用户列表</h3>
                                      <p :class="['text-sm mt-1', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">共 {{ userTotal }} 个用户</p>
                                  </div>
                                  <div class="flex flex-wrap items-center gap-2">
                                      <!-- 批量操作 -->
                                      <div v-if="selectedUserIds.size > 0" class="flex items-center gap-2">
                                          <span :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']">已选 {{ selectedUserIds.size }} 个</span>
                                          <button
                                              @click="batchDeleteUsers"
                                              class="px-3 py-1.5 rounded-lg text-sm font-medium bg-red-500 hover:bg-red-600 text-white transition-colors"
                                          >
                                              批量删除
                                          </button>
                                          <button
                                              @click="clearSelection"
                                              :class="['px-3 py-1.5 rounded-lg text-sm font-medium transition-colors', backgroundColor === 'dark' ? 'bg-gray-700 hover:bg-gray-600 text-gray-300' : 'bg-gray-200 hover:bg-gray-300 text-gray-700']"
                                          >
                                              取消选择
                                          </button>
                                      </div>
                                      <!-- 每页数量选择 -->
                                      <select
                                          :value="userPerPage"
                                          @change="changePerPage(parseInt($event.target.value))"
                                          :class="['px-3 py-1.5 rounded-lg text-sm border cursor-pointer', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-700']"
                                      >
                                          <option v-for="opt in perPageOptions" :key="opt" :value="opt">{{ opt }} 条/页</option>
                                      </select>
                                      <button
                                          @click="loadAllUsers"
                                          :class="['px-4 py-1.5 rounded-lg text-sm font-medium transition-colors', backgroundColor === 'dark' ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']"
                                      >
                                          刷新
                                      </button>
                                  </div>
                              </div>

                              <div v-if="allUsers.length === 0" class="text-center py-12">
                                  <p :class="['text-lg opacity-60', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">暂无用户</p>
                              </div>

                              <div v-else :class="['rounded-lg overflow-hidden', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                                  <div class="overflow-x-auto">
                                      <table class="w-full min-w-[600px] md:min-w-full">
                                          <thead :class="['text-left text-sm font-medium', backgroundColor === 'dark' ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700']">
                                              <tr>
                                                  <th class="px-4 py-3 w-12">
                                                      <input
                                                          type="checkbox"
                                                          :checked="selectAllCurrentPage"
                                                          @change="toggleSelectAll"
                                                          :class="['w-4 h-4 rounded cursor-pointer', backgroundColor === 'dark' ? 'bg-gray-600 border-gray-500' : 'border-gray-300']"
                                                      />
                                                  </th>
                                                  <th class="px-4 py-3 w-16">ID</th>
                                                  <th class="px-4 py-3">用户名</th>
                                                  <th class="px-4 py-3 hidden sm:table-cell">注册时间</th>
                                                  <th class="px-4 py-3 text-right">操作</th>
                                              </tr>
                                          </thead>
                                          <tbody :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">
                                              <tr
                                                  v-for="u in allUsers"
                                                  :key="u.id"
                                                  :class="['border-t transition-colors',
                                                      selectedUserIds.has(u.id) ? (backgroundColor === 'dark' ? 'bg-blue-900/30' : 'bg-blue-50') : '',
                                                      backgroundColor === 'dark' ? 'border-gray-700 hover:bg-gray-750' : 'border-gray-100 hover:bg-gray-50']"
                                              >
                                                  <td class="px-4 py-3">
                                                      <input
                                                          v-if="u.id !== user.id && u.username !== 'admin'"
                                                          type="checkbox"
                                                          :checked="selectedUserIds.has(u.id)"
                                                          @change="toggleUserSelect(u.id)"
                                                          :class="['w-4 h-4 rounded cursor-pointer', backgroundColor === 'dark' ? 'bg-gray-600 border-gray-500' : 'border-gray-300']"
                                                      />
                                                  </td>
                                                  <td class="px-4 py-3">{{ u.id }}</td>
                                                  <td class="px-4 py-3">
                                                      <div class="flex flex-col sm:flex-row sm:items-center">
                                                          <span :class="['font-medium', u.username === 'admin' ? 'text-purple-500' : '']">{{ u.username }}</span>
                                                          <div class="flex gap-1 mt-1 sm:mt-0 sm:ml-2">
                                                              <span v-if="u.username === 'admin'" class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">Admin</span>
                                                              <span v-if="u.id === user.id" class="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">自己</span>
                                                          </div>
                                                      </div>
                                                      <!-- 移动端显示注册时间 -->
                                                      <div class="sm:hidden text-[10px] opacity-50 mt-1">
                                                          {{ new Date(u.created_at).toLocaleString() }}
                                                      </div>
                                                  </td>
                                                  <td class="px-4 py-3 hidden sm:table-cell">{{ new Date(u.created_at).toLocaleString() }}</td>
                                                   <td class="px-4 py-3 text-right">
                                                        <div class="flex justify-end gap-2">
                                                            <button
                                                                v-if="u.id !== user.id"
                                                                @click="deleteUser(u.id)"
                                                                :class="['px-2 py-1 rounded text-xs font-medium text-red-500 hover:bg-red-50 transition-colors', backgroundColor === 'dark' ? 'hover:bg-gray-700' : '']"
                                                                title="删除用户"
                                                            >
                                                                删除
                                                            </button>
                                                            <button
                                                                v-if="u.id === user.id"
                                                                @click="openChangePassword"
                                                                :class="['px-2 py-1 rounded text-xs font-medium text-blue-500 hover:bg-blue-50 transition-colors', backgroundColor === 'dark' ? 'hover:bg-gray-700' : '']"
                                                                title="修改密码"
                                                            >
                                                                修改密码
                                                            </button>
                                                            <span v-if="u.id !== user.id && u.username === 'admin'" class="text-gray-400 text-xs">-</span>
                                                         </div>
                                                     </td>
                                               </tr>
                                           </tbody>
                                       </table>
                                   </div>

                                  <!-- 分页控件 -->
                                  <div v-if="userTotalPages > 1" :class="['flex flex-col sm:flex-row justify-between items-center gap-4 px-4 py-3 border-t', backgroundColor === 'dark' ? 'border-gray-700' : 'border-gray-200']">
                                      <div :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">
                                          第 {{ userPage }} / {{ userTotalPages }} 页，共 {{ userTotal }} 条
                                      </div>
                                      <div class="flex items-center gap-1">
                                          <button
                                              @click="goToPage(1)"
                                              :disabled="userPage === 1"
                                              :class="['px-2 py-1 rounded text-sm transition-colors', userPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']"
                                          >
                                              首页
                                          </button>
                                          <button
                                              @click="goToPage(userPage - 1)"
                                              :disabled="userPage === 1"
                                              :class="['px-3 py-1 rounded text-sm transition-colors', userPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']"
                                          >
                                              上一页
                                          </button>
                                          <!-- 页码按钮 -->
                                          <template v-for="p in getVisiblePages()" :key="p">
                                              <span v-if="p === '...'" :class="['px-2 py-1 text-sm', backgroundColor === 'dark' ? 'text-gray-500' : 'text-gray-400']">...</span>
                                              <button
                                                  v-else
                                                  @click="goToPage(p)"
                                                  :class="['px-3 py-1 rounded text-sm transition-colors',
                                                      userPage === p
                                                          ? (backgroundColor === 'dark' ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white')
                                                          : (backgroundColor === 'dark' ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-600 hover:bg-gray-100')]"
                                              >
                                                  {{ p }}
                                              </button>
                                          </template>
                                          <button
                                              @click="goToPage(userPage + 1)"
                                              :disabled="userPage === userTotalPages"
                                              :class="['px-3 py-1 rounded text-sm transition-colors', userPage === userTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']"
                                          >
                                              下一页
                                          </button>
                                          <button
                                              @click="goToPage(userTotalPages)"
                                              :disabled="userPage === userTotalPages"
                                              :class="['px-2 py-1 rounded text-sm transition-colors', userPage === userTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']"
                                          >
                                              末页
                                          </button>
                                      </div>
                                  </div>
                              </div>
                              
                              <!-- SMTP 配置区域 -->
                              <div :class="['mt-6 p-4 rounded-lg', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                                  <div class="flex justify-between items-center mb-4">
                                      <div>
                                          <h3 class="text-lg font-semibold" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">邮件服务配置</h3>
                                          <p :class="['text-sm mt-1', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">用于密码找回功能</p>
                                      </div>
                                      <div class="flex items-center gap-2">
                                          <span :class="['text-sm', smtpConfig.smtp_enabled === 'true' ? 'text-green-500' : 'text-gray-400']">
                                              {{ smtpConfig.smtp_enabled === 'true' ? '已启用' : '未启用' }}
                                          </span>
                                          <button 
                                              @click="smtpConfig.smtp_enabled = smtpConfig.smtp_enabled === 'true' ? 'false' : 'true'"
                                              :class="['relative w-12 h-6 rounded-full transition-colors', smtpConfig.smtp_enabled === 'true' ? 'bg-green-500' : (backgroundColor === 'dark' ? 'bg-gray-600' : 'bg-gray-300')]"
                                          >
                                              <span :class="['absolute top-1 w-4 h-4 rounded-full bg-white transition-all', smtpConfig.smtp_enabled === 'true' ? 'right-1' : 'left-1']"></span>
                                          </button>
                                      </div>
                                  </div>
                                  
                                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      <div>
                                          <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">SMTP 服务器</label>
                                          <input v-model="smtpConfig.smtp_server" type="text" placeholder="smtp.gmail.com" :class="['w-full px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-200 text-gray-800 placeholder-gray-400']" />
                                      </div>
                                      <div>
                                          <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">端口</label>
                                          <input v-model="smtpConfig.smtp_port" type="text" placeholder="587" :class="['w-full px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-200 text-gray-800 placeholder-gray-400']" />
                                      </div>
                                      <div>
                                          <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">用户名 (邮箱)</label>
                                          <input v-model="smtpConfig.smtp_username" type="text" placeholder="your@email.com" :class="['w-full px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-200 text-gray-800 placeholder-gray-400']" />
                                      </div>
                                      <div>
                                          <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">密码/授权码</label>
                                          <input v-model="smtpConfig.smtp_password" type="password" placeholder="••••••••" :class="['w-full px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-200 text-gray-800 placeholder-gray-400']" />
                                      </div>
                                      <div>
                                          <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">发件人名称</label>
                                          <input v-model="smtpConfig.smtp_from_name" type="text" placeholder="ReadZen" :class="['w-full px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-200 text-gray-800 placeholder-gray-400']" />
                                      </div>
                                      <div>
                                          <label :class="['block text-sm font-medium mb-1', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">发件人邮箱</label>
                                          <input v-model="smtpConfig.smtp_from_email" type="text" placeholder="noreply@example.com" :class="['w-full px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-200 text-gray-800 placeholder-gray-400']" />
                                      </div>
                                  </div>
                                  
                                  <div class="flex flex-wrap gap-4 mt-4">
                                      <label class="flex items-center gap-2 cursor-pointer">
                                          <input type="checkbox" v-model="smtpConfigTls" class="w-4 h-4 rounded" />
                                          <span :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">使用 TLS</span>
                                      </label>
                                      <label class="flex items-center gap-2 cursor-pointer">
                                          <input type="checkbox" v-model="smtpConfigSsl" class="w-4 h-4 rounded" />
                                          <span :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-700']">使用 SSL</span>
                                      </label>
                                  </div>
                                  
                                  <div class="flex flex-col sm:flex-row gap-2 mt-4">
                                      <button @click="saveSmtpConfig" :disabled="savingSmtp" :class="['px-4 py-2 rounded-lg text-sm font-medium', savingSmtp ? 'opacity-50 cursor-not-allowed' : '', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white']">
                                          {{ savingSmtp ? '保存中...' : '保存配置' }}
                                      </button>
                                      <button @click="testSmtpConfig" :disabled="testingSmtp" :class="['px-4 py-2 rounded-lg text-sm font-medium border', testingSmtp ? 'opacity-50 cursor-not-allowed' : '', backgroundColor === 'dark' ? 'border-gray-600 hover:bg-gray-700 text-gray-300' : 'border-gray-300 hover:bg-gray-50 text-gray-700']">
                                          {{ testingSmtp ? '发送中...' : '发送测试邮件' }}
                                      </button>
                                  </div>
                              </div>
                              
                              <!-- 管理员重置密码区域 -->
                              <div :class="['mt-6 p-4 rounded-lg', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                                  <h3 class="text-lg font-semibold mb-4" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">管理员重置密码</h3>
                                  <p :class="['text-sm mb-3', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">当用户忘记密码且未配置邮件服务时，可在此手动重置</p>
                                  <div class="flex flex-col sm:flex-row gap-2">
                                      <select v-model="resetPasswordUserId" :class="['flex-1 px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-200 text-gray-800']">
                                          <option value="">选择用户</option>
                                          <option v-for="u in allUsers.filter(u => u.id !== user.id)" :key="u.id" :value="u.id">{{ u.username }}</option>
                                      </select>
                                      <input v-model="resetPasswordNew" type="password" placeholder="新密码" :class="['flex-1 px-3 py-2 rounded-lg border text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-200 text-gray-800 placeholder-gray-400']" />
                                      <button @click="adminResetPassword" :disabled="!resetPasswordUserId || !resetPasswordNew" :class="['px-4 py-2 rounded-lg text-sm font-medium', (!resetPasswordUserId || !resetPasswordNew) ? 'opacity-50 cursor-not-allowed' : '', backgroundColor === 'dark' ? 'bg-orange-600 hover:bg-orange-700 text-white' : 'bg-orange-500 hover:bg-orange-600 text-white']">
                                          重置密码
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 关于页面 -->
                  <div v-else-if="activeTab === 'about'" class="h-full overflow-y-auto p-6">
                      <div class="max-w-2xl mx-auto">
                          <div :class="['rounded-lg p-6 mb-6', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                              <div class="text-center mb-6">
                                  <h2 class="text-2xl font-bold mb-2" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">ReadZen</h2>
                                  <p :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">享受阅读时光</p>
                              </div>

                              <div v-if="loadingVersion" class="text-center py-8">
                                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 mx-auto mb-3" :style="{ borderColor: backgroundColor === 'dark' ? '#9ca3af' : '#6b7280' }"></div>
                                  <p :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">加载版本信息...</p>
                              </div>

                              <div v-else :class="['space-y-4', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']">
                                  <div class="flex justify-between items-center py-2 border-b" :style="{ borderColor: backgroundColor === 'dark' ? '#374151' : '#e5e7eb' }">
                                      <span :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">版本</span>
                                      <span class="font-mono text-sm font-medium">{{ versionInfo.version || '-' }}</span>
                                  </div>
                                  <div class="flex justify-between items-center py-2 border-b" :style="{ borderColor: backgroundColor === 'dark' ? '#374151' : '#e5e7eb' }">
                                      <span :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">构建时间</span>
                                      <span class="font-mono text-sm">{{ versionInfo.build_date || '-' }}</span>
                                  </div>
                                  <div class="flex justify-between items-center py-2 border-b" :style="{ borderColor: backgroundColor === 'dark' ? '#374151' : '#e5e7eb' }">
                                      <span :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">Git 分支</span>
                                      <span class="font-mono text-sm">{{ versionInfo.git_branch || '-' }}</span>
                                  </div>
                                  <div class="flex justify-between items-center py-2">
                                      <span :class="['text-sm', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">Git 提交</span>
                                      <span class="font-mono text-sm" :title="versionInfo.git_commit">{{ versionInfo.git_commit ? versionInfo.git_commit.substring(0, 8) : '-' }}</span>
                                  </div>
                              </div>
                          </div>

                          <div :class="['rounded-lg p-6 mb-6', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                              <h3 class="text-lg font-semibold mb-4" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">项目地址</h3>
                              <a
                                  :href="versionInfo.repository || 'https://github.com/TIANXUAN13/ReadZen'"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  :class="['flex items-center gap-2 text-sm transition-colors', backgroundColor === 'dark' ? 'text-blue-400 hover:text-blue-300' : 'text-blue-500 hover:text-blue-600']"
                              >
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                      <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                  </svg>
                                  <span>GitHub - TIANXUAN13/ReadZen</span>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                  </svg>
                              </a>
                          </div>

                          <div :class="['rounded-lg p-6', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white border border-gray-200']">
                              <h3 class="text-lg font-semibold mb-4" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }">关于项目</h3>
                              <div :class="['text-sm leading-relaxed space-y-3', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-600']">
                                  <p>ReadZen 是一款禅意风格的每日一文阅读器，支持本地文章上传与管理。</p>
                                  <p>主要功能：</p>
                                  <ul class="list-disc list-inside space-y-1 ml-2">
                                      <li>每日一文推荐</li>
                                      <li>本地文章上传（支持单文件和文件夹）</li>
                                      <li>文章收藏与管理</li>
                                      <li>个性化阅读设置</li>
                                      <li>用户认证与权限管理</li>
                                  </ul>
                              </div>
                          </div>

                          <div class="mt-6 text-center">
                              <p class="text-[10px] opacity-40">Content provided by qhsou.com</p>
                          </div>
                      </div>
                  </div>

                    <!-- 设置面板遮罩层 -->
                    <div v-if="showSettings" 
                         class="fixed inset-0 z-40 bg-black bg-opacity-10 pointer-events-auto" 
                         style="overflow-y: auto; -webkit-overflow-scrolling: touch;"
                         @click="handleSettingsBackdropClick">
                    </div>
                    
                    <!-- 设置面板 - 避免影响滚动 -->
                    <div v-if="showSettings" 
                         :style="{ top: settingsPosition.top + 'px', left: settingsPosition.left + 'px' }" 
                         :class="['fixed z-50 rounded-lg shadow-lg border p-4 min-w-[200px] max-w-[calc(100vw-2rem)] transition-colors duration-300', isDark ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-100']" 
                         @click.stop>
                    <div class="flex justify-between items-center mb-3">
                        <h3 :style="{ color: textClass }" class="text-sm font-medium">阅读设置</h3>
                        <button @click="showSettings = false" :style="{ color: isDark ? '#9ca3af' : '#6b7280' }" class="hover:text-gray-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- 用户管理选项 (已登录用户显示) -->
                    <template v-if="user">
                        <div class="mb-3 border-t pt-3" :style="{ borderColor: isDark ? '#374151' : '#e5e7eb' }">
                            <div class="flex items-center justify-between mb-2">
                                <span :style="{ color: textClass }" class="text-sm font-medium">{{ user.username }}</span>
                            </div>
                            
                            <!-- 邮箱显示 -->
                            <div v-if="user.email" class="mb-2 px-3 py-2 rounded text-xs" :style="{ color: isDark ? '#9ca3af' : '#6b7280' }">
                                <span>邮箱: {{ user.email }}</span>
                            </div>
                            
                            <button 
                                @click="openChangePassword"
                                :class="['w-full flex items-center gap-2 px-3 py-2 rounded text-sm transition-colors mb-1', hoverBgClass + ' text-gray-700']"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                                修改密码
                            </button>
                            
                            <button 
                                @click="openChangeEmail"
                                :class="['w-full flex items-center gap-2 px-3 py-2 rounded text-sm transition-colors mb-1', hoverBgClass + ' text-gray-700']"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                修改邮箱
                            </button>
                            
                            <button 
                                @click="doLogout"
                                :class="['w-full flex items-center gap-2 px-3 py-2 rounded text-sm transition-colors', hoverBgClass + ' text-gray-700']"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                登出
                            </button>
                        </div>
                    </template>
                    
                    <!-- 字体大小调整 -->
                    <div class="mb-3">
                        <label :style="{ color: isDark ? '#9ca3af' : '#6b7280' }" class="block text-xs mb-2">字体大小</label>
                        <div class="flex items-center justify-between gap-3">
                            <button 
                                @click="adjustFontSize(-1)" 
                                :class="['p-2 rounded-full transition-colors', hoverBgClass]"
                                aria-label="减小字体"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <span :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }" class="text-sm font-medium w-12 text-center">{{ fontSize }}px</span>
                            <button 
                                @click="adjustFontSize(1)" 
                                :class="['p-2 rounded-full transition-colors', backgroundColor === 'dark' ? 'hover:bg-gray-800' : 'hover:bg-gray-100']"
                                aria-label="增大字体"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                        <!-- 字体大小滑块 -->
                        <input 
                            type="range" 
                            min="14" 
                            max="28" 
                            v-model.number="fontSize" 
                            :class="['w-full mt-3 h-1 rounded-lg appearance-none cursor-pointer', backgroundColor === 'dark' ? 'bg-gray-700 accent-white' : 'bg-gray-200 accent-gray-600']"
                        >
                    </div>
                    
                    <!-- 背景色选择 -->
                    <div class="mb-3">
                        <label :style="{ color: backgroundColor === 'dark' ? '#9ca3af' : '#6b7280' }" class="block text-xs mb-2">阅读背景</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button 
                                @click="backgroundColor = 'paper'"
                                :class="[
                                    'p-2 rounded-lg flex flex-col items-center gap-1 transition-all',
                                    backgroundColor === 'paper' 
                                        ? (backgroundColor === 'dark' ? 'ring-2 ring-white bg-gray-800' : 'ring-2 ring-gray-500 bg-gray-100') 
                                        : (backgroundColor === 'dark' ? 'hover:bg-gray-800' : 'hover:bg-gray-100')
                                ]"
                                aria-label="纸张色"
                            >
                                <div class="w-6 h-6 rounded-full bg-[#fdfbf7] border border-gray-300"></div>
                                <span :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }" class="text-xs">纸张色</span>
                            </button>
                            <button 
                                @click="backgroundColor = 'white'"
                                :class="[
                                    'p-2 rounded-lg flex flex-col items-center gap-1 transition-all',
                                    backgroundColor === 'white' 
                                        ? (backgroundColor === 'dark' ? 'ring-2 ring-white bg-gray-800' : 'ring-2 ring-gray-500 bg-gray-100') 
                                        : (backgroundColor === 'dark' ? 'hover:bg-gray-800' : 'hover:bg-gray-100')
                                ]"
                                aria-label="纯白色"
                            >
                                <div class="w-6 h-6 rounded-full bg-white border border-gray-300"></div>
                                <span :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }" class="text-xs">纯白色</span>
                            </button>
                            <button 
                                @click="backgroundColor = 'dark'"
                                :class="[
                                    'p-2 rounded-lg flex flex-col items-center gap-1 transition-all',
                                    backgroundColor === 'dark' 
                                        ? (backgroundColor === 'dark' ? 'ring-2 ring-white bg-gray-800' : 'ring-2 ring-gray-500 bg-gray-100') 
                                        : (backgroundColor === 'dark' ? 'hover:bg-gray-800' : 'hover:bg-gray-100')
                                ]"
                                aria-label="深色模式"
                            >
                                <div class="w-6 h-6 rounded-full bg-[#1a1a1a] border border-gray-300"></div>
                                <span :style="{ color: backgroundColor === 'dark' ? '#e5e7eb' : '#374151' }" class="text-xs">深色模式</span>
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 修改密码弹窗 -->
            <div v-if="showChangePassword" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @click.self="showChangePassword = false">
                <div :class="['w-96 p-6 rounded-lg shadow-xl', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white']">
                    <div class="flex justify-between items-center mb-4">
                        <h3 :class="['text-lg font-semibold', backgroundColor === 'dark' ? 'text-white' : 'text-gray-800']">
                            修改密码
                        </h3>
                        <button @click="showChangePassword = false" :class="['text-gray-500 hover:text-gray-700', backgroundColor === 'dark' ? 'text-gray-400 hover:text-gray-300' : '']">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <input 
                        v-model="changePasswordForm.old_password"
                        type="password"
                        placeholder="旧密码"
                        :class="['w-full px-3 py-2 mb-3 border rounded text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800']"
                    />
                    <input 
                        v-model="changePasswordForm.new_password"
                        type="password"
                        placeholder="新密码"
                        :class="['w-full px-3 py-2 mb-3 border rounded text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800']"
                    />
                    <input 
                        v-model="changePasswordForm.confirm_password"
                        type="password"
                        placeholder="确认新密码"
                        @keyup.enter="doChangePassword"
                        :class="['w-full px-3 py-2 mb-4 border rounded text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800']"
                    />
                    
                    <div v-if="changePasswordError" :class="['text-sm mb-3', backgroundColor === 'dark' ? 'text-red-400' : 'text-red-500']">
                        {{ changePasswordError }}
                    </div>
                    
                    <button
                        @click="doChangePassword"
                        :class="['w-full py-2 rounded text-sm font-medium text-white transition-colors', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600']"
                        :disabled="changePasswordLoading"
                    >
                        {{ changePasswordLoading ? '修改中...' : '确认修改' }}
                    </button>
                </div>
            </div>

            <!-- 修改用户名弹窗 -->
            <div v-if="showChangeUsername" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @click.self="showChangeUsername = false">
                <div :class="['w-96 p-6 rounded-lg shadow-xl', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white']">
                    <div class="flex justify-between items-center mb-4">
                        <h3 :class="['text-lg font-semibold', backgroundColor === 'dark' ? 'text-white' : 'text-gray-800']">
                            修改用户名
                        </h3>
                        <button @click="showChangeUsername = false" :class="['text-gray-500 hover:text-gray-700', backgroundColor === 'dark' ? 'text-gray-400 hover:text-gray-300' : '']">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <p :class="['text-xs mb-3', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">
                        用户名只能包含字母、数字、下划线和中文，长度2-20个字符
                    </p>

                    <input
                        v-model="changeUsernameForm.new_username"
                        type="text"
                        placeholder="新用户名"
                        :class="['w-full px-3 py-2 mb-3 border rounded text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800']"
                    />
                    <input
                        v-model="changeUsernameForm.password"
                        type="password"
                        placeholder="输入密码确认身份"
                        @keyup.enter="doChangeUsername"
                        :class="['w-full px-3 py-2 mb-4 border rounded text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800']"
                    />

                    <div v-if="changeUsernameError" :class="['text-sm mb-3', backgroundColor === 'dark' ? 'text-red-400' : 'text-red-500']">
                        {{ changeUsernameError }}
                    </div>

                    <button
                        @click="doChangeUsername"
                        :class="['w-full py-2 rounded text-sm font-medium text-white transition-colors', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600']"
                        :disabled="changeUsernameLoading"
                    >
                        {{ changeUsernameLoading ? '修改中...' : '确认修改' }}
                    </button>
                </div>
            </div>

            <!-- 修改邮箱弹窗 -->
            <div v-if="showChangeEmail" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @click.self="showChangeEmail = false">
                <div :class="['w-96 p-6 rounded-lg shadow-xl', backgroundColor === 'dark' ? 'bg-gray-800' : 'bg-white']">
                    <div class="flex justify-between items-center mb-4">
                        <h3 :class="['text-lg font-semibold', backgroundColor === 'dark' ? 'text-white' : 'text-gray-800']">
                            修改邮箱
                        </h3>
                        <button @click="showChangeEmail = false" :class="['text-gray-500 hover:text-gray-700', backgroundColor === 'dark' ? 'text-gray-400 hover:text-gray-300' : '']">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div v-if="!changeEmailStep2">
                        <input 
                            v-model="changeEmailForm.new_email"
                            type="email"
                            placeholder="新邮箱地址"
                            :class="['w-full px-3 py-2 mb-3 border rounded text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800']"
                        />
                        <p :class="['text-xs mb-4', backgroundColor === 'dark' ? 'text-gray-400' : 'text-gray-500']">
                            将发送验证码到新邮箱
                        </p>
                        <button 
                            @click="doChangeEmail"
                            :class="['w-full py-2 rounded text-sm font-medium text-white transition-colors', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600']"
                            :disabled="changeEmailLoading"
                        >
                            {{ changeEmailLoading ? '发送中...' : '发送验证码' }}
                        </button>
                    </div>
                    
                    <div v-else>
                        <p :class="['text-sm mb-3', backgroundColor === 'dark' ? 'text-gray-300' : 'text-gray-600']">
                            验证码已发送至: {{ changeEmailForm.new_email }}
                        </p>
                        <input 
                            v-model="changeEmailForm.code"
                            type="text"
                            placeholder="验证码"
                            maxlength="6"
                            :class="['w-full px-3 py-2 mb-4 border rounded text-sm', backgroundColor === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800']"
                        />
                        <div class="flex gap-2">
                            <button 
                                @click="changeEmailStep2 = false"
                                :class="['flex-1 py-2 rounded text-sm font-medium border transition-colors', backgroundColor === 'dark' ? 'border-gray-600 hover:bg-gray-700 text-gray-300' : 'border-gray-300 hover:bg-gray-50 text-gray-700']"
                            >
                                返回
                            </button>
                            <button 
                                @click="doVerifyChangeEmail"
                                :class="['flex-1 py-2 rounded text-sm font-medium text-white transition-colors', backgroundColor === 'dark' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600']"
                                :disabled="changeEmailLoading"
                            >
                                {{ changeEmailLoading ? '验证中...' : '确认修改' }}
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="changeEmailError" :class="['text-sm mt-3', backgroundColor === 'dark' ? 'text-red-400' : 'text-red-500']">
                        {{ changeEmailError }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed, watch, reactive, nextTick } = Vue;

        createApp({
            setup() { 
                 const article = ref(null);
                 const loading = ref(true);
                 const error = ref(null);
                 const currentDate = ref('');
                 const fontSize = ref(18);
                 const showSettings = ref(false);
                 const settingsPosition = ref({ top: 0, left: 0 });
                 const settingsButtonRef = ref(null);
                 const activeTab = ref(localStorage.getItem('readzen_active_tab') || 'daily');
                 const isUploadMenuOpen = ref(localStorage.getItem('readzen_upload_menu_open') === 'true');
                 // 背景色选项：paper（默认纸张色）, white（纯白）, dark（黑色）
                 const backgroundColor = ref('paper');

                 // 简化样式计算属性
                 const isDark = computed(() => backgroundColor.value === 'dark');
                 const bgClass = computed(() => isDark.value ? 'bg-gray-900' : 'bg-white');
                 const textClass = computed(() => isDark.value ? 'text-gray-100' : 'text-gray-800');
                 const borderClass = computed(() => isDark.value ? 'border-gray-700' : 'border-gray-200');
                 const hoverBgClass = computed(() => isDark.value ? 'hover:bg-gray-800' : 'hover:bg-gray-100');
                 const cardBgClass = computed(() => isDark.value ? 'bg-gray-800' : 'bg-white');
                 const badgeBgClass = computed(() => isDark.value ? 'bg-gray-700' : 'bg-blue-200');

                 // 导航菜单激活状态样式
                 const navActiveClass = computed(() => isDark.value ? 'bg-gray-800 text-white' : 'bg-blue-100 text-blue-800');

                 // 本地文章列表
                 const localArticles = ref([]);
                 // 保存当前查看的每日一文，避免切换后重新请求
                 const currentDailyArticle = ref(null);
                 // 侧边栏展开/折叠状态
                 const isSidebarCollapsed = ref(true);
                 
                 // 计算侧边栏激活项的偏移量
                 const navIndicatorOffset = computed(() => {
                     const order = {
                         'daily': 0,
                         'favorites': 1,
                         'admin': 2,
                         'upload-list': 3 // 简化逻辑，假设上传列表在后面
                     };
                     
                     // 实际情况可能更复杂，因为有折叠菜单和 admin 权限
                     // 这里我们通过一个数组来精确查找
                     const items = ['daily', 'favorites'];
                     if (user.value && user.username === 'admin') items.push('admin');
                     
                     const index = items.indexOf(activeTab.value);
                     if (index !== -1) return index * 56; // 56px 是每个项目的高度+间距
                     return -100; // 隐藏
                 });

                 const favoriteArticles = ref([]);
                 // 标记当前是否在查看本地/收藏文章（避免被每日一文覆盖）
                 const isViewingLocal = ref(false);

                 // 阅读进度条
                 const readingProgress = ref(0);

                 // Toast 通知系统
                 const toasts = ref([]);
                 const showToast = (msg, type = 'info') => {
                     const id = Date.now();
                     toasts.value.push({ id, msg, type });
                     setTimeout(() => {
                         toasts.value = toasts.value.filter(t => t.id !== id);
                     }, 3000);
                 };

                 // 上传的文章列表（从数据库获取）
                 const uploadedArticles = ref([]);

                // 版本信息
                const versionInfo = ref({
                    version: 'dev',
                    build_date: '',
                    git_commit: '',
                    git_branch: '',
                    repository: 'https://github.com/TIANXUAN13/ReadZen'
                });
                const loadingVersion = ref(false);

                // 加载版本信息
                const loadVersionInfo = async () => {
                    loadingVersion.value = true;
                    try {
                        const res = await fetch('/api/version');
                        if (res.ok) {
                            versionInfo.value = await res.json();
                        }
                    } catch (e) {
                        console.error('获取版本信息失败:', e);
                    } finally {
                        loadingVersion.value = false;
                    }
                };

                // 监听标签页切换，保存到 localStorage
                 watch(activeTab, (newTab) => {
                     localStorage.setItem('readzen_active_tab', newTab);

                     // 如果切换到上传相关的标签，自动展开上传菜单
                     if (['upload-file', 'upload-folder', 'upload-list'].includes(newTab)) {
                         isUploadMenuOpen.value = true;
                     }

                     // 切换到关于页面时加载版本信息
                     if (newTab === 'about') {
                         loadVersionInfo();
                     }
                 });

                 // 监听上传菜单展开状态
                 watch(isUploadMenuOpen, (isOpen) => {
                     localStorage.setItem('readzen_upload_menu_open', isOpen);
                 });

                 // 获取上传的文章列表
                 const loadUploadedArticles = async () => {
                     try {
                         const res = await fetch('/api/uploaded', { credentials: 'include' });
                         if (res.ok) {
                             uploadedArticles.value = await res.json();
                         }
                     } catch (e) {
                         console.error('获取上传文章失败:', e);
                     }
                 };

                 // 切换上传菜单展开/折叠
                 const toggleUploadMenu = () => {
                     isUploadMenuOpen.value = !isUploadMenuOpen.value;
                 };

                 // 处理上传选项点击
                 const handleUploadOption = (option) => {
                     isUploadMenuOpen.value = false;

                     if (option === 'upload-file') {
                         selectSingleFile();
                     } else if (option === 'upload-folder') {
                         selectFolder();
                     } else if (option === 'upload-list') {
                         activeTab.value = 'upload-list';
                         isSidebarCollapsed.value = true;
                         showToast('已进入上传列表', 'info');
                     }
                 };

                 // 获取页面标题
                 const getPageTitle = () => {
                     const titleMap = {
                         'daily': '每日一文',
                         'favorites': '收藏文章',
                         'admin': '用户管理',
                         'profile': '个人信息',
                         'upload-file': '上传文件',
                         'upload-folder': '上传文件夹',
                         'upload-list': '上传列表',
                         'about': '关于'
                     };
                     return titleMap[activeTab.value] || '本地文章';
                 };

                 // 保存上传的文章到数据库
                 const saveUploadedArticle = async (article) => {
                     try {
                         const res = await fetch('/api/uploaded', {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify(article),
                             credentials: 'include'
                         });
                         if (res.ok) {
                             const data = await res.json();
                             return data.id;
                         }
                         return null;
                     } catch (e) {
                         console.error('保存上传文章失败:', e);
                         return null;
                     }
                 };
                
                 // 删除上传的文章
                 const deleteUploadedArticle = async (articleId) => {
                     try {
                         const res = await fetch(`/api/uploaded/${articleId}`, {
                             method: 'DELETE',
                             credentials: 'include'
                         });
                         if (res.ok) {
                             uploadedArticles.value = uploadedArticles.value.filter(a => a.id !== articleId);
                         }
                     } catch (e) {
                         console.error('删除上传文章失败:', e);
                     }
                 };

                 // 下载单个上传的文章
                 const downloadUploadedArticle = (article) => {
                     const blob = new Blob([article.content], { type: 'text/plain;charset=utf-8' });
                     const url = window.URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = (article.file_name || article.title) + '.txt';
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     window.URL.revokeObjectURL(url);
                 };

                 // 批量下载上传的文章（ZIP）
                 const downloadUploadedZip = async () => {
                     if (uploadedArticles.value.length === 0) {
                         alert('没有可下载的上传文章');
                        return;
                    }

                    const JSZip = (await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm')).default;
                    const zip = new JSZip();

                    uploadedArticles.value.forEach((article, index) => {
                        const fileName = (article.file_name || article.title) + '.txt';
                        zip.file(fileName, article.content);
                    });

                    const content = await zip.generateAsync({ type: 'blob' });
                    const url = window.URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '上传文章.zip';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                };

                 const addToFavorites = async (article) => {
                     if (!user.value) {
                         showToast('请先登录后再收藏文章', 'error');
                         openAuth('login');
                         return false;
                     }
                     
                     // 检查是否已收藏
                     const isAlreadyFavorited = isItemFavorited(article);
                     if (isAlreadyFavorited) {
                         // 如果已经收藏，再次点击则取消收藏（同步每日一文逻辑）
                         const fav = favoriteArticles.value.find(
                             f => f.title === article.title && f.author === article.author
                         );
                         if (fav && fav.id) {
                             await removeFavorite(fav.id);
                             showToast('已取消收藏', 'info');
                         }
                         return false;
                     }
                     
                     try {
                         const res = await fetch('/api/favorites', {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify(article),
                             credentials: 'include'
                         });
                         if (res.ok) {
                             const data = await res.json();
                             favoriteArticles.value.unshift({
                                 ...article,
                                 id: data.id,
                                 dateAdded: new Date().toISOString()
                             });
                             showToast('文章收藏成功', 'success');
                             return true;
                         }
                         return false;
                     } catch (e) {
                         console.error('收藏文章失败:', e);
                         showToast('收藏失败，请稍后重试', 'error');
                         return false;
                     }
                 };

                 // 检查文章是否已收藏
                 const isItemFavorited = (item) => {
                     if (!item) return false;
                     return favoriteArticles.value.some(
                         fav => fav.title === item.title && fav.author === item.author
                     );
                 };
                
                // 一键收藏所有上传的文章
                const addAllToFavorites = async () => {
                    if (!user.value) {
                        alert('请先登录后再收藏文章');
                        return;
                    }
                    if (uploadedArticles.value.length === 0) {
                        alert('没有可收藏的文章');
                        return;
                    }
                    
                    // 过滤掉已收藏的文章
                    const newArticles = uploadedArticles.value.filter(article => {
                        return !favoriteArticles.value.some(
                            fav => fav.title === article.title && fav.author === article.author
                        );
                    });
                    
                    if (newArticles.length === 0) {
                        alert('所有文章都已收藏过了');
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/favorites/batch-add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ articles: newArticles }),
                            credentials: 'include'
                        });
                        if (res.ok) {
                            const data = await res.json();
                            alert(`成功收藏 ${data.added} 篇文章`);
                            // 刷新收藏列表
                            loadFavorites();
                        }
                    } catch (e) {
                        console.error('批量收藏失败:', e);
                        alert('收藏失败，请重试');
                    }
                };

                // 批量下载收藏文章
                const downloadFavoritesZip = async () => {
                    if (favoriteArticles.value.length === 0) {
                        alert('没有可下载的收藏文章');
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/favorites/download', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ articles: favoriteArticles.value }),
                            credentials: 'include'
                        });
                        if (res.ok) {
                            // 获取文件名并下载
                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = '收藏文章.zip';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }
                    } catch (e) {
                        console.error('下载失败:', e);
                        alert('下载失败，请重试');
                    }
                };
                
                // 加载收藏列表
                const loadFavorites = async () => {
                    try {
                        const res = await fetch('/api/favorites', { credentials: 'include' });
                        if (res.ok) {
                            favoriteArticles.value = await res.json();
                        }
                    } catch (e) {
                        console.error('加载收藏失败:', e);
                    }
                };

                // 一键清空上传列表
                const clearUploaded = async () => {
                    if (!uploadedArticles.value || uploadedArticles.value.length === 0) {
                        alert('没有可清空的上传文章');
                        return;
                    }
                    if (!confirm('确定要清空上传列表吗？该操作不可撤销。')) return;
                    try {
                        const res = await fetch('/api/uploaded/clear', {
                            method: 'POST',
                            credentials: 'include'
                        });
                        if (res.ok) {
                            const data = await res.json();
                            uploadedArticles.value = [];
                            showToast(`已清空 ${data.count || 0} 篇文章`, 'success');
                        } else {
                            const err = await res.json();
                            alert(err.error || '清空失败');
                        }
                    } catch (e) {
                        console.error('清空上传列表失败:', e);
                        alert('清空失败，请稍后重试');
                    }
                };
                
                
                // 认证相关状态
                const user = ref(null);
                const showAuth = ref(false);
                const authMode = ref('login');
                const loginForm = reactive({ username: '', password: '', captcha: '' });
                const regForm = reactive({ username: '', email: '', password: '', confirm_password: '', captcha: '' });
                const captchaImage = ref('');
                
                // 获取验证码图片
                const fetchCaptcha = async () => {
                    try {
                        const res = await fetch('/api/captcha', { credentials: 'include' });
                        if (res.ok) {
                            const data = await res.json();
                            captchaImage.value = 'data:image/png;base64,' + data.captcha_image;
                        }
                    } catch (e) {
                        console.error('获取验证码失败:', e);
                    }
                };
                
                // 刷新验证码
                const refreshCaptcha = () => {
                    captchaImage.value = '';
                    fetchCaptcha();
                };
                
                // 检查当前登录用户
                const checkCurrentUser = async () => {
                    try {
                        const res = await fetch('/api/auth/me', { credentials: 'include' });
                        if (res.ok) user.value = await res.json();
                        else user.value = null;
                    } catch (e) {
                        user.value = null;
                    }
                };
                
                // 打开认证弹窗
                const openAuth = (mode) => {
                    authMode.value = mode;
                    loginForm.username = '';
                    loginForm.password = '';
                    loginForm.captcha = '';
                    regForm.username = '';
                    regForm.email = '';
                    regForm.password = '';
                    regForm.confirm_password = '';
                    regForm.captcha = '';
                    fetchCaptcha();
                    showAuth.value = true;
                };
                
                // 登录
                const doLogin = async () => {
                    const resp = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: loginForm.username, 
                            password: loginForm.password,
                            captcha: loginForm.captcha 
                        }),
                        credentials: 'include'
                    });
                    if (resp.ok) {
                        await checkCurrentUser();
                        showAuth.value = false;
                    } else {
                        const err = await resp.json();
                        alert(err.error || '登录失败');
                        if (err.error && err.error.includes('验证码')) {
                            refreshCaptcha();
                        }
                    }
                };
                
                // 注册
                const doRegister = async () => {
                    if (!regForm.email) {
                        showToast('请输入邮箱地址', 'error');
                        return;
                    }
                    if (regForm.password !== regForm.confirm_password) {
                        showToast('两次输入的密码不一致', 'error');
                        return;
                    }
                    const resp = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: regForm.username, 
                            email: regForm.email,
                            password: regForm.password,
                            confirm_password: regForm.confirm_password,
                            captcha: regForm.captcha 
                        }),
                        credentials: 'include'
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        user.value = data;
                        showAuth.value = false;
                        if (data.message) {
                            showToast(data.message, 'success');
                        }
                    } else {
                        const err = await resp.json();
                        alert(err.error || '注册失败');
                        if (err.error && err.error.includes('验证码')) {
                            refreshCaptcha();
                        }
                    }
                };
                
                // 登出
                const doLogout = async () => {
                    await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
                    user.value = null;
                };
                
                // 初始检查用户
                checkCurrentUser();
                loadUploadedArticles();
                loadFavorites();

                // 背景色配置
                const bgColors = {
                    paper: { bg: '#fdfbf7', text: '#374151', prose: 'prose-slate' },
                    white: { bg: '#ffffff', text: '#374151', prose: 'prose-slate' },
                    dark: { bg: '#1a1a1a', text: '#e5e7eb', prose: 'prose-invert' }
                };

                // 初始化数据
                const initData = () => {
                    // 初始化本地文章列表
                    localArticles.value = [];
                };

                // 获取当前日期
                const formatDate = (date) => {
                    if (!date) {
                        const currentDate = new Date();
                        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                        return currentDate.toLocaleDateString('zh-CN', options);
                    }
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    return new Date(date).toLocaleDateString('zh-CN', options);
                };

                // 计算阅读时长（假设每分钟阅读300字）
                const readingTime = computed(() => {
                    if (!article.value) return 0;
                    // 移除HTML标签，计算纯文本字数
                    const text = article.value.content.replace(/<[^>]*>/g, '');
                    const wordCount = text.length;
                    return Math.ceil(wordCount / 300);
                });

                // 获取文章
                const getArticle = async () => {
                    loading.value = true;
                    error.value = null;
                    isViewingLocal.value = false;
                    
                    // 滚动到顶部
                    nextTick(() => {
                        const articleElement = document.querySelector('article');
                        if (articleElement) {
                            articleElement.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                    
                    try {
                        // 使用后端代理接口获取文章，避免跨域问题
                        const response = await fetch('/api/daily', { credentials: 'include' });
                        
                        if (!response.ok) {
                            throw new Error('网络请求失败');
                        }

                        const data = await response.json();
                        
                        // 检查是否是错误响应
                        if (data.error) {
                            throw new Error(data.message || '获取文章失败');
                        }
                        
                        // 更新文章数据
                        article.value = data;
                        currentDailyArticle.value = data;
                    } catch (err) {
                        console.error(err);
                        error.value = data?.message || '无法获取每日一文，请检查网络连接后重试。你可以通过"选择文件夹"或"选择文件"功能上传本地文章进行阅读。';
                    } finally {
                        loading.value = false;
                    }
                };

                // 调整字体大小
                const adjustFontSize = (delta) => {
                    fontSize.value = Math.max(14, Math.min(28, fontSize.value + delta));
                };

                // 切换设置面板显示
                const toggleSettings = (event) => {
                    if (event) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    if (!showSettings.value) {
                        // 使用 ref 获取按钮位置，更可靠
                        let button = settingsButtonRef.value;
                        if (!button && event && event.target) {
                            button = event.target.closest('button');
                        }
                        
                        if (button) {
                            const rect = button.getBoundingClientRect();
                            settingsPosition.value = {
                                top: rect.bottom + 8,
                                left: rect.right - 200
                            };
                            if (settingsPosition.value.left < 16) {
                                settingsPosition.value.left = 16;
                            }
                            if (settingsPosition.value.left + 200 > window.innerWidth - 16) {
                                settingsPosition.value.left = window.innerWidth - 216;
                            }
                        } else {
                            settingsPosition.value = {
                                top: 64,
                                left: window.innerWidth - 216
                            };
                        }
                    }
                    
                    showSettings.value = !showSettings.value;
                };

                // 处理设置面板遮罩层点击
                const handleSettingsBackdropClick = (event) => {
                    if (event.target === event.currentTarget) {
                        showSettings.value = false;
                    }
                };
                
                // 选择文件夹
                const selectFolder = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.webkitdirectory = true;
                    input.multiple = true;
                    input.accept = '.txt,.md,.text,.log,.article,.htm,.html,text/*';

                    input.onchange = (e) => {
                        const files = e.target.files;
                        console.log('Selected files:', files.length);
                        if (files.length === 0) {
                            alert('未选择任何文件');
                            return;
                        }
                        readLocalFiles(Array.from(files));
                        activeTab.value = 'upload-list';
                    };

                    input.click();
                };

                // 选择单个文件
                const selectSingleFile = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.multiple = false;
                    input.accept = '.txt,.md,.text,.log,.article,.htm,.html,text/*';

                    input.onchange = (e) => {
                        const files = e.target.files;
                        console.log('Selected files:', files.length);
                        if (files.length === 0) {
                            alert('未选择任何文件');
                            return;
                        }
                        readLocalFiles(Array.from(files));
                        activeTab.value = 'upload-list';
                    };

                    input.click();
                };

                // 读取本地文件
                const readLocalFiles = (files) => {
                    localArticles.value = [];
                    let loadedCount = 0;
                    const totalFiles = files.length;
                    let validFilesCount = 0;

                    // 先统计有效的txt/md/html文件数量
                    files.forEach(file => {
                        const fileName = file.name.toLowerCase();
                        const isTextFile = fileName.endsWith('.txt') || 
                                          fileName.endsWith('.md') || 
                                          fileName.endsWith('.text') || 
                                          fileName.endsWith('.log') ||
                                          fileName.endsWith('.article') ||
                                          fileName.endsWith('.htm') ||
                                          fileName.endsWith('.html') ||
                                          file.type.includes('text') ||
                                          file.type === '' ||
                                          fileName.endsWith('.utf8') ||
                                          fileName.endsWith('.ansi');
                        
                        if (isTextFile && !file.name.startsWith('.') && file.size > 0) {
                            validFilesCount++;
                        }
                    });

                    if (validFilesCount === 0) {
                        alert('所选文件夹中没有找到可读的文章文件（支持 .txt, .md, .html 等格式）\n请确保文件不是隐藏文件且有实际内容。');
                        return;
                    }

                    files.forEach(file => {
                        const fileName = file.name.toLowerCase();
                        // 扩展文件类型检测
                        const isTextFile = fileName.endsWith('.txt') || 
                                          fileName.endsWith('.md') || 
                                          fileName.endsWith('.text') || 
                                          fileName.endsWith('.log') ||
                                          fileName.endsWith('.article') ||
                                          fileName.endsWith('.htm') ||
                                          fileName.endsWith('.html') ||
                                          file.type.includes('text') ||
                                          file.type === '' ||
                                          fileName.endsWith('.utf8') ||
                                          fileName.endsWith('.ansi');

                        if (isTextFile && !file.name.startsWith('.') && file.size > 0) {
                            const reader = new FileReader();
                                reader.onload = (e) => {
                                    const content = e.target.result;
                                    const lines = content.split('\n');
                                    let title = file.name.replace(/\.(txt|md|text|log|htm|html|article)$/i, '');
                                    let author = '未知作者';
                                    let articleContent = content;

                                    // 尝试从文件内容中提取标题和作者
                                    if (lines.length > 0 && lines[0].trim()) {
                                        // 如果第一行比较短（小于100字符），把它作为标题
                                        let firstLineRaw = lines[0].trim();
                                        if (firstLineRaw.length < 100 && !firstLineRaw.startsWith('<')) {
                                            // 去掉前缀标识，如 "标题: 狗难" -> "狗难"
                                            let firstLine = firstLineRaw.replace(/^(标题|Title|题名)[:：]\s*/i, '');
                                            if (firstLine.length > 0) {
                                                title = firstLine;
                                            }
                                        }
                                    }
                                if (lines.length > 1) {
                                    const authorLine = lines[1].trim();
                                    if (authorLine.startsWith('作者：') || authorLine.startsWith('作者:') || 
                                        authorLine.startsWith('Author:') || authorLine.startsWith('author:') ||
                                        authorLine.startsWith('【作者】') || authorLine.startsWith('作者 】')) {
                                        author = authorLine.replace(/作者：|作者:|Author:|author:|【作者】|作者 】/, '').trim();
                                        articleContent = lines.slice(2).join('\n');
                                    }
                                }

                                // 转换内容为HTML
                                let htmlContent;
                                if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
                                    // HTML文件直接使用内容
                                    htmlContent = articleContent;
                                } else {
                                    // 纯文本文件转换为HTML段落
                                    htmlContent = articleContent
                                        .split('\n\n')
                                        .filter(paragraph => paragraph.trim())
                                        .map(paragraph => `<p>${paragraph.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`)
                                        .join('');
                                }

                                localArticles.value.push({
                                    id: Date.now() + Math.random(),
                                    title,
                                    author,
                                    content: htmlContent,
                                    originalContent: content, // 保存原始内容用于下载
                                    fileName: file.name,
                                    fileSize: file.size,
                                    lastModified: file.lastModified
                                });

                                // 同时保存到数据库
                                saveUploadedArticle({
                                    title,
                                    author,
                                    content: htmlContent,
                                    fileName: file.name,
                                    fileSize: file.size
                                });

                                 loadedCount++;
                                 if (loadedCount === validFilesCount) {
                                     console.log(`成功加载 ${localArticles.value.length} 篇文章`);
                                     // 所有文件处理完成后，刷新上传列表并跳转
                                     setTimeout(async () => {
                                         await loadUploadedArticles();
                                         // 跳转到上传列表页
                                         activeTab.value = 'upload-list';
                                         isSidebarCollapsed.value = true;
                                     }, 500);
                                 }
                            };
                            reader.onerror = (e) => {
                                console.error('Error reading file:', file.name, e);
                                loadedCount++;
                            };
                            reader.readAsText(file, 'utf-8');
                        } else {
                            loadedCount++;
                        }
                    });
                };

                // 查看本地文章
                const viewLocalArticle = (localArticle) => {
                    article.value = localArticle;
                    activeTab.value = 'daily';
                    isSidebarCollapsed.value = true;
                    isViewingLocal.value = true;
                    
                    // 滚动到顶部
                    nextTick(() => {
                        const articleElement = document.querySelector('article');
                        if (articleElement) {
                            articleElement.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                };

                // 处理文章滚动事件
                const handleArticleScroll = (event) => {
                    const el = event.target;
                    const scrollTop = el.scrollTop;
                    const scrollHeight = el.scrollHeight;
                    const clientHeight = el.clientHeight;

                    // 1. 更新阅读进度条
                    const total = scrollHeight - clientHeight;
                    if (total > 0) {
                        readingProgress.value = (scrollTop / total) * 100;
                    }

                    // 2. 如果正在打开侧边栏，忽略这次滚动事件
                    if (isOpeningSidebar.value) return;
                    
                    // 3. 当文章滚动距离超过阈值时，自动关闭侧边栏
                    // 只在非顶部位置滚动时关闭侧边栏
                    if (scrollTop > 50 && scrollTop < scrollHeight - clientHeight - 50) {
                        isSidebarCollapsed.value = true;
                    }
                };

                // 监听设置面板状态，锁定/解锁滚动防止页面抖动
                watch(showSettings, (newVal) => {
                    if (newVal) {
                        // 打开面板时锁定滚动
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                    } else {
                        // 关闭面板时恢复滚动
                        document.body.style.overflow = '';
                        document.body.style.position = '';
                        document.body.style.width = '';
                    }
                });

                // 打开侧边栏
                const isOpeningSidebar = ref(false);
                const openSidebar = () => {
                    // 设置标志，防止点击时误触发滚动关闭
                    isOpeningSidebar.value = true;
                    setTimeout(() => {
                        isOpeningSidebar.value = false;
                    }, 300);
                    
                    // 记录当前滚动位置
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    
                    // 锁定滚动
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                    document.body.style.top = `-${scrollTop}px`;
                    
                    // 打开侧边栏
                    isSidebarCollapsed.value = false;
                };

                // 关闭侧边栏
                const closeSidebar = () => {
                    // 获取之前保存的滚动位置
                    const scrollTop = parseInt(document.body.style.top.replace('-', '').replace('px', '')) || 0;
                    
                    isSidebarCollapsed.value = true;
                    
                    // 恢复滚动
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                    document.body.style.top = '';
                    
                    // 恢复滚动位置
                    window.scrollTo(0, scrollTop);
                };

                // 监听背景色变化，更新body样式
                watch(backgroundColor, (newColor) => {
                    const body = document.body;
                    if (newColor === 'dark') {
                        body.classList.add('bg-black');
                        body.classList.remove('bg-slate-50');
                        body.style.color = '#e5e7eb';
                    } else {
                        body.classList.remove('bg-black');
                        body.classList.add('bg-slate-50');
                        body.style.color = '#374151';
                    }
                }, { immediate: true });

                // 监听标签切换
                watch(activeTab, (newTab) => {
                    if (newTab === 'daily') {
                        // 如果正在查看本地/收藏文章，不自动获取新文章
                        if (isViewingLocal.value) {
                            loading.value = false;
                            return;
                        }
                        // 如果有保存的当前文章，直接显示，否则获取新文章
                        if (currentDailyArticle.value) {
                            article.value = currentDailyArticle.value;
                            loading.value = false;
                        } else {
                            getArticle();
                        }
                    }
                 });

                // 切换收藏状态
                const toggleFavorite = async () => {
                    if (!article.value) return;
                    const isFav = favoriteArticles.value.some(fav => fav.id === article.value.id);
                    if (isFav) {
                        // 取消收藏
                        const fav = favoriteArticles.value.find(fav => fav.id === article.value.id);
                        if (fav && fav.fav_id) {
                            await fetch(`/api/favorites?id=${fav.fav_id}`, { method: 'DELETE', credentials: 'include' });
                        }
                        favoriteArticles.value = favoriteArticles.value.filter(fav => fav.id !== article.value.id);
                    } else {
                        // 添加收藏到服务器
                        if (!user.value) {
                            alert('请先登录后再收藏文章');
                            openAuth('login');
                            return;
                        }
                        const resp = await fetch('/api/favorites', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: article.value.id,
                                title: article.value.title,
                                author: article.value.author,
                                content: article.value.content
                            }),
                            credentials: 'include'
                        });
                        if (resp.ok) {
                            const data = await resp.json();
                            favoriteArticles.value.push({ ...article.value, fav_id: data.id, dateAdded: new Date().toISOString() });
                        } else {
                            const err = await resp.json();
                            alert(err.error || '收藏失败');
                        }
                    }
                };

                // 是否已收藏
                const isFavorited = computed(() => article.value && favoriteArticles.value.some(fav => fav.id === article.value.id));

                // 下载收藏的文章
                const downloadFavorite = (item) => {
                    // 提取纯文本内容（去除HTML标签）
                    let content = item.content || '';
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const plainText = tempDiv.textContent || tempDiv.innerText || '';
                    
                    // 构建下载内容
                    const downloadContent = `${item.title}\n作者：${item.author || '佚名'}\n\n${plainText}`;
                    
                    // 创建Blob并下载
                    const blob = new Blob([downloadContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${item.title}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                // 下载本地文章
                const downloadLocalArticle = (item) => {
                    // 使用保存的原始内容，如果没有则从HTML提取
                    let content = item.originalContent || '';
                    if (!content) {
                        let htmlContent = item.content || '';
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        content = tempDiv.textContent || tempDiv.innerText || '';
                    }
                    
                    // 构建下载内容
                    const downloadContent = `${item.title}\n作者：${item.author || '佚名'}\n\n${content}`;
                    
                    // 创建Blob并下载
                    const blob = new Blob([downloadContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${item.title}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                // 移除收藏
                const removeFavorite = async (id) => {
                    // 调用 API 删除数据库中的记录
                    await fetch(`/api/favorites?id=${id}`, { method: 'DELETE', credentials: 'include' });
                    // 从本地列表移除
                    favoriteArticles.value = favoriteArticles.value.filter(fav => fav.id !== id);
                };
                
                // 用户管理相关
                const allUsers = ref([]);
                const loadingUsers = ref(false);
                // 分页相关
                const userPage = ref(1);
                const userPerPage = ref(10);
                const userTotal = ref(0);
                const userTotalPages = ref(0);
                const perPageOptions = [10, 20, 50, 100];
                // 多选相关
                const selectedUserIds = ref(new Set()); // 跨页多选，使用 Set 存储
                const selectAllCurrentPage = ref(false);

                const loadAllUsers = async () => {
                    if (!user.value || user.value.username !== 'admin') {
                        allUsers.value = [];
                        return;
                    }
                    loadingUsers.value = true;
                    try {
                        const res = await fetch(`/api/admin/users?page=${userPage.value}&per_page=${userPerPage.value}`, { credentials: 'include' });
                        if (res.ok) {
                            const data = await res.json();
                            allUsers.value = data.users;
                            userTotal.value = data.total;
                            userTotalPages.value = data.total_pages;
                            // 更新当前页的全选状态
                            updateSelectAllState();
                        } else {
                            const err = await res.json();
                            alert(err.error || '加载用户列表失败');
                        }
                    } catch (e) {
                        console.error('加载用户列表失败:', e);
                        alert('加载用户列表失败');
                    } finally {
                        loadingUsers.value = false;
                    }
                };

                // 切换每页显示数量
                const changePerPage = (newPerPage) => {
                    userPerPage.value = newPerPage;
                    userPage.value = 1; // 重置到第一页
                    loadAllUsers();
                };

                // 翻页
                const goToPage = (page) => {
                    if (page >= 1 && page <= userTotalPages.value) {
                        userPage.value = page;
                        loadAllUsers();
                    }
                };

                // 更新当前页全选状态
                const updateSelectAllState = () => {
                    const currentPageIds = allUsers.value
                        .filter(u => u.id !== user.value?.id && u.username !== 'admin')
                        .map(u => u.id);
                    selectAllCurrentPage.value = currentPageIds.length > 0 &&
                        currentPageIds.every(id => selectedUserIds.value.has(id));
                };

                // 切换单个用户选择
                const toggleUserSelect = (userId) => {
                    if (selectedUserIds.value.has(userId)) {
                        selectedUserIds.value.delete(userId);
                    } else {
                        selectedUserIds.value.add(userId);
                    }
                    // 触发响应式更新
                    selectedUserIds.value = new Set(selectedUserIds.value);
                    updateSelectAllState();
                };

                // 当前页全选/取消全选
                const toggleSelectAll = () => {
                    const selectableUsers = allUsers.value.filter(u => u.id !== user.value?.id && u.username !== 'admin');
                    if (selectAllCurrentPage.value) {
                        // 取消全选
                        selectableUsers.forEach(u => selectedUserIds.value.delete(u.id));
                    } else {
                        // 全选
                        selectableUsers.forEach(u => selectedUserIds.value.add(u.id));
                    }
                    selectedUserIds.value = new Set(selectedUserIds.value);
                    updateSelectAllState();
                };

                // 批量删除选中用户
                const batchDeleteUsers = async () => {
                    if (selectedUserIds.value.size === 0) {
                        alert('请先选择要删除的用户');
                        return;
                    }
                    if (!confirm(`确定要删除选中的 ${selectedUserIds.value.size} 个用户吗？这些用户的所有收藏也将被删除。`)) {
                        return;
                    }
                    try {
                        const res = await fetch('/api/admin/users/batch', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ user_ids: Array.from(selectedUserIds.value) })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            alert(`成功删除 ${data.deleted_count} 个用户`);
                            selectedUserIds.value = new Set();
                            loadAllUsers();
                        } else {
                            const err = await res.json();
                            alert(err.error || '批量删除失败');
                        }
                    } catch (e) {
                        console.error('批量删除失败:', e);
                        alert('批量删除失败');
                    }
                };

                // 清除所有选择
                const clearSelection = () => {
                    selectedUserIds.value = new Set();
                    updateSelectAllState();
                };

                // 计算可见页码
                const getVisiblePages = () => {
                    const current = userPage.value;
                    const total = userTotalPages.value;
                    const pages = [];

                    if (total <= 7) {
                        for (let i = 1; i <= total; i++) {
                            pages.push(i);
                        }
                    } else {
                        if (current <= 4) {
                            for (let i = 1; i <= 5; i++) {
                                pages.push(i);
                            }
                            pages.push('...');
                            pages.push(total);
                        } else if (current >= total - 3) {
                            pages.push(1);
                            pages.push('...');
                            for (let i = total - 4; i <= total; i++) {
                                pages.push(i);
                            }
                        } else {
                            pages.push(1);
                            pages.push('...');
                            for (let i = current - 1; i <= current + 1; i++) {
                                pages.push(i);
                            }
                            pages.push('...');
                            pages.push(total);
                        }
                    }
                    return pages;
                };

                const deleteUser = async (userId) => {
                    if (!confirm('确定要删除该用户吗？该用户的所有收藏也将被删除。')) {
                        return;
                    }
                    try {
                        const res = await fetch(`/api/admin/users/${userId}`, { 
                            method: 'DELETE',
                            credentials: 'include' 
                        });
                        if (res.ok) {
                            allUsers.value = allUsers.value.filter(u => u.id !== userId);
                        } else {
                            const err = await res.json();
                            alert(err.error || '删除用户失败');
                        }
                    } catch (e) {
                        console.error('删除用户失败:', e);
                        alert('删除用户失败');
                    }
                };
                
                // SMTP 配置相关
                const smtpConfig = reactive({
                    smtp_server: '',
                    smtp_port: '587',
                    smtp_username: '',
                    smtp_password: '',
                    smtp_from_name: 'ReadZen',
                    smtp_from_email: '',
                    smtp_use_ssl: 'false',
                    smtp_use_tls: 'true',
                    smtp_enabled: 'false'
                });
                const smtpConfigTls = computed({
                    get: () => smtpConfig.smtp_use_tls === 'true',
                    set: (val) => smtpConfig.smtp_use_tls = val ? 'true' : 'false'
                });
                const smtpConfigSsl = computed({
                    get: () => smtpConfig.smtp_use_ssl === 'true',
                    set: (val) => smtpConfig.smtp_use_ssl = val ? 'true' : 'false'
                });
                const savingSmtp = ref(false);
                const testingSmtp = ref(false);
                
                const loadSmtpConfig = async () => {
                    if (!user.value || user.value.username !== 'admin') return;
                    try {
                        const res = await fetch('/api/admin/smtp', { credentials: 'include' });
                        if (res.ok) {
                            const data = await res.json();
                            Object.keys(data).forEach(key => {
                                if (key in smtpConfig) {
                                    smtpConfig[key] = data[key] || '';
                                }
                            });
                        }
                    } catch (e) {
                        console.error('加载SMTP配置失败:', e);
                    }
                };
                
                const saveSmtpConfig = async () => {
                    savingSmtp.value = true;
                    try {
                        const res = await fetch('/api/admin/smtp', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(smtpConfig),
                            credentials: 'include'
                        });
                        if (res.ok) {
                            showToast('SMTP配置已保存', 'success');
                        } else {
                            const err = await res.json();
                            showToast(err.error || '保存失败', 'error');
                        }
                    } catch (e) {
                        showToast('保存失败', 'error');
                    } finally {
                        savingSmtp.value = false;
                    }
                };
                
                const testSmtpConfig = async () => {
                    const email = prompt('请输入测试邮箱地址：');
                    if (!email) return;
                    
                    testingSmtp.value = true;
                    try {
                        const res = await fetch('/api/admin/smtp/test', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email }),
                            credentials: 'include'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            showToast(data.message || '测试邮件已发送', 'success');
                        } else {
                            showToast(data.error || '发送失败', 'error');
                        }
                    } catch (e) {
                        showToast('发送失败', 'error');
                    } finally {
                        testingSmtp.value = false;
                    }
                };
                
                // 管理员重置用户密码
                const resetPasswordUserId = ref('');
                const resetPasswordNew = ref('');
                
                const adminResetPassword = async () => {
                    if (!resetPasswordUserId.value || !resetPasswordNew.value) return;
                    if (!confirm('确定要重置该用户的密码吗？')) return;
                    
                    try {
                        const res = await fetch(`/api/admin/reset-password/${resetPasswordUserId.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: resetPasswordNew.value }),
                            credentials: 'include'
                        });
                        if (res.ok) {
                            showToast('密码已重置', 'success');
                            resetPasswordUserId.value = '';
                            resetPasswordNew.value = '';
                        } else {
                            const err = await res.json();
                            showToast(err.error || '重置失败', 'error');
                        }
                    } catch (e) {
                        showToast('重置失败', 'error');
                    }
                };
                
                // 忘记密码相关
                const showForgotPassword = ref(false);
                const smtpEnabled = ref(false);
                const smtpInfo = ref({});
                const forgotStep = ref(1);
                const forgotEmail = ref('');
                const forgotCode = ref('');
                const forgotNewPassword = ref('');
                const sendingCode = ref(false);
                const resettingPassword = ref(false);
                
                const checkSmtpEnabled = async () => {
                    try {
                        const res = await fetch('/api/auth/check-smtp');
                        const data = await res.json();
                        smtpEnabled.value = data.enabled;
                        smtpInfo.value = data;
                    } catch (e) {
                        smtpEnabled.value = false;
                    }
                };
                
                const openForgotPassword = async () => {
                    await checkSmtpEnabled();
                    forgotStep.value = 1;
                    forgotEmail.value = '';
                    forgotCode.value = '';
                    forgotNewPassword.value = '';
                    showForgotPassword.value = true;
                };
                
                const closeForgotPassword = () => {
                    showForgotPassword.value = false;
                    authMode.value = 'login';
                    showAuth.value = true;
                };
                
                const sendResetCode = async () => {
                    if (!forgotEmail.value) return;
                    
                    sendingCode.value = true;
                    try {
                        const res = await fetch('/api/auth/forgot-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: forgotEmail.value }),
                            credentials: 'include'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            showToast(data.message || '验证码已发送', 'success');
                            forgotStep.value = 2;
                        } else {
                            showToast(data.error || '发送失败', 'error');
                        }
                    } catch (e) {
                        showToast('发送失败', 'error');
                    } finally {
                        sendingCode.value = false;
                    }
                };
                
                const resetPassword = async () => {
                    if (!forgotCode.value || !forgotNewPassword.value) return;
                    
                    resettingPassword.value = true;
                    try {
                        const res = await fetch('/api/auth/reset-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: forgotEmail.value,
                                code: forgotCode.value,
                                password: forgotNewPassword.value
                            }),
                            credentials: 'include'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            showToast(data.message || '密码重置成功', 'success');
                            forgotStep.value = 3;
                        } else {
                            showToast(data.error || '重置失败', 'error');
                        }
                    } catch (e) {
                        showToast('重置失败', 'error');
                    } finally {
                        resettingPassword.value = false;
                    }
                };

                // 修改密码相关
                const showChangePassword = ref(false);
                const changePasswordForm = reactive({
                    old_password: '',
                    new_password: '',
                    confirm_password: ''
                });
                const changePasswordError = ref('');
                const changePasswordLoading = ref(false);

                const openChangePassword = () => {
                    changePasswordForm.old_password = '';
                    changePasswordForm.new_password = '';
                    changePasswordForm.confirm_password = '';
                    changePasswordError.value = '';
                    showChangePassword.value = true;
                };

                const doChangePassword = async () => {
                    changePasswordError.value = '';
                    
                    if (!changePasswordForm.old_password || !changePasswordForm.new_password) {
                        changePasswordError.value = '请填写完整信息';
                        return;
                    }
                    
                    if (changePasswordForm.new_password !== changePasswordForm.confirm_password) {
                        changePasswordError.value = '两次输入的密码不一致';
                        return;
                    }
                    
                    if (changePasswordForm.new_password.length < 6) {
                        changePasswordError.value = '新密码长度不能少于6位';
                        return;
                    }
                    
                    changePasswordLoading.value = true;
                    
                    try {
                        const res = await fetch('/api/auth/change-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                old_password: changePasswordForm.old_password,
                                new_password: changePasswordForm.new_password
                            }),
                            credentials: 'include'
                        });
                        
                        if (res.ok) {
                            showChangePassword.value = false;
                            alert('密码修改成功');
                        } else {
                            const err = await res.json();
                            changePasswordError.value = err.error || '修改失败';
                        }
                    } catch (e) {
                        console.error('修改密码失败:', e);
                        changePasswordError.value = '修改失败，请稍后重试';
                    } finally {
                        changePasswordLoading.value = false;
                    }
                };

                // 修改用户名相关
                const showChangeUsername = ref(false);
                const changeUsernameForm = reactive({
                    new_username: '',
                    password: ''
                });
                const changeUsernameError = ref('');
                const changeUsernameLoading = ref(false);

                const openChangeUsername = () => {
                    changeUsernameForm.new_username = '';
                    changeUsernameForm.password = '';
                    changeUsernameError.value = '';
                    showChangeUsername.value = true;
                };

                const doChangeUsername = async () => {
                    changeUsernameError.value = '';

                    if (!changeUsernameForm.new_username || !changeUsernameForm.password) {
                        changeUsernameError.value = '请填写完整信息';
                        return;
                    }

                    if (changeUsernameForm.new_username.length < 2 || changeUsernameForm.new_username.length > 20) {
                        changeUsernameError.value = '用户名长度需要2-20个字符';
                        return;
                    }

                    changeUsernameLoading.value = true;

                    try {
                        const res = await fetch('/api/auth/change-username', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                new_username: changeUsernameForm.new_username,
                                password: changeUsernameForm.password
                            }),
                            credentials: 'include'
                        });

                        if (res.ok) {
                            const data = await res.json();
                            showChangeUsername.value = false;
                            // 更新本地用户信息
                            user.value = { ...user.value, username: data.username };
                            showToast('用户名修改成功', 'success');
                        } else {
                            const err = await res.json();
                            changeUsernameError.value = err.error || '修改失败';
                        }
                    } catch (e) {
                        console.error('修改用户名失败:', e);
                        changeUsernameError.value = '修改失败，请稍后重试';
                    } finally {
                        changeUsernameLoading.value = false;
                    }
                };

                // 修改邮箱相关
                const showChangeEmail = ref(false);
                const changeEmailStep2 = ref(false);
                const changeEmailForm = reactive({
                    new_email: '',
                    code: ''
                });
                const changeEmailError = ref('');
                const changeEmailLoading = ref(false);

                const openChangeEmail = () => {
                    changeEmailForm.new_email = '';
                    changeEmailForm.code = '';
                    changeEmailError.value = '';
                    changeEmailStep2.value = false;
                    showChangeEmail.value = true;
                };

                const doChangeEmail = async () => {
                    changeEmailError.value = '';
                    
                    if (!changeEmailForm.new_email) {
                        changeEmailError.value = '请输入邮箱地址';
                        return;
                    }
                    
                    changeEmailLoading.value = true;
                    
                    try {
                        const res = await fetch('/api/auth/change-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: changeEmailForm.new_email
                            }),
                            credentials: 'include'
                        });
                        
                        const data = await res.json();
                        if (res.ok && data.need_code) {
                            changeEmailStep2.value = true;
                            showToast('验证码已发送到新邮箱', 'success');
                        } else if (res.ok) {
                            showChangeEmail.value = false;
                            await checkCurrentUser();
                            showToast(data.message || '邮箱修改成功', 'success');
                        } else {
                            changeEmailError.value = data.error || '发送失败';
                        }
                    } catch (e) {
                        console.error('修改邮箱失败:', e);
                        changeEmailError.value = '发送失败，请稍后重试';
                    } finally {
                        changeEmailLoading.value = false;
                    }
                };

                const doVerifyChangeEmail = async () => {
                    changeEmailError.value = '';
                    
                    if (!changeEmailForm.code) {
                        changeEmailError.value = '请输入验证码';
                        return;
                    }
                    
                    changeEmailLoading.value = true;
                    
                    try {
                        const res = await fetch('/api/auth/change-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: changeEmailForm.new_email,
                                code: changeEmailForm.code
                            }),
                            credentials: 'include'
                        });
                        
                        const data = await res.json();
                        if (res.ok) {
                            showChangeEmail.value = false;
                            await checkCurrentUser();
                            showToast(data.message || '邮箱修改成功', 'success');
                        } else {
                            changeEmailError.value = data.error || '验证失败';
                        }
                    } catch (e) {
                        console.error('验证邮箱失败:', e);
                        changeEmailError.value = '验证失败，请稍后重试';
                    } finally {
                        changeEmailLoading.value = false;
                    }
                };

                // 重发验证邮件
                const resendVerification = async () => {
                    try {
                        const res = await fetch('/api/auth/resend-verification', {
                            method: 'POST',
                            credentials: 'include'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            showToast(data.message || '验证邮件已发送', 'success');
                        } else {
                            showToast(data.error || '发送失败', 'error');
                        }
                    } catch (e) {
                        showToast('发送失败', 'error');
                    }
                };

                // 当切换到用户管理页面时加载用户列表
                watch(() => activeTab.value, (newTab) => {
                    if (newTab === 'admin') {
                        loadAllUsers();
                        loadSmtpConfig();
                    }
                });

                 // 当用户登录状态变化时
                 watch(() => user.value, (newUser) => {
                     if (newUser) {
                         loadFavorites();
                         // 如果当前就在用户管理页面，登录后自动加载列表
                         if (activeTab.value === 'admin') {
                             loadAllUsers();
                         }
                     } else {
                         favoriteArticles.value = [];
                         allUsers.value = [];
                     }
                 }, { immediate: true });

                 onMounted(async () => {
                     initData();
                     
                     // 1. 先检查用户信息
                     // 这会触发 watch(() => user.value)，进而根据当前 activeTab 加载 收藏 或 用户列表
                     await checkCurrentUser();
                     
                     // 2. 对于非用户依赖的页面，手动触发加载
                     if (activeTab.value === 'daily') {
                         getArticle();
                     } else if (activeTab.value === 'upload-list') {
                         loadUploadedArticles();
                     }
                 });

                 return {
                     article,
                     loading,
                     error,
                     currentDate: computed(() => formatDate()),
                     fontSize,
                     showSettings,
                     settingsPosition,
                     settingsButtonRef,
                     activeTab,
                     isUploadMenuOpen,
                     openSidebar,
                     isOpeningSidebar,
                     closeSidebar,
                     backgroundColor,
                     isDark,
                     bgClass,
                     textClass,
                     borderClass,
                     hoverBgClass,
                     cardBgClass,
                     badgeBgClass,
                     navActiveClass,
                     localArticles,
                         favoriteArticles,
                        toggleFavorite,
                         isFavorited,
                         removeFavorite,
                         downloadFavorite,
                         downloadLocalArticle,
                         loadFavorites,
                         uploadedArticles,
                         loadUploadedArticles,
                         addToFavorites,
                         isItemFavorited,
                         addAllToFavorites,
                         downloadFavoritesZip,
                          saveUploadedArticle,
                          clearUploaded,
                         deleteUploadedArticle,
                         downloadUploadedArticle,
                         downloadUploadedZip,
                         toggleUploadMenu,
                         handleUploadOption,
                         getPageTitle,
                        bgColors,
                       readingTime,
                     isViewingLocal,
                     readingProgress,
                     toasts,
                     showToast,
                     user,
                        showAuth,
                        authMode,
                        loginForm,
                        regForm,
                        captchaImage,
                        openAuth,
                        doLogin,
                         doRegister,
                         doLogout,
                         fetchCaptcha,
                         refreshCaptcha,
                        allUsers,
                        loadingUsers,
                        loadAllUsers,
                        deleteUser,
                        // 分页相关
                        userPage,
                        userPerPage,
                        userTotal,
                        userTotalPages,
                        perPageOptions,
                        changePerPage,
                        goToPage,
                        getVisiblePages,
                        // 多选相关
                        selectedUserIds,
                        selectAllCurrentPage,
                        toggleUserSelect,
                        toggleSelectAll,
                        batchDeleteUsers,
                        clearSelection,
                        showChangePassword,
                        changePasswordForm,
                        changePasswordError,
                        changePasswordLoading,
                        openChangePassword,
                        doChangePassword,
                        showChangeUsername,
                        changeUsernameForm,
                        changeUsernameError,
                        changeUsernameLoading,
                        openChangeUsername,
                        doChangeUsername,
                        showChangeEmail,
                        changeEmailStep2,
                        changeEmailForm,
                        changeEmailError,
                        changeEmailLoading,
                        openChangeEmail,
                        doChangeEmail,
                        doVerifyChangeEmail,
                        resendVerification,
                        formatDate,
                        getArticle,
                         adjustFontSize,
                         toggleSettings,
                          handleSettingsBackdropClick,
                          viewLocalArticle,
                         selectFolder,
                         selectSingleFile,
isSidebarCollapsed,
                          handleArticleScroll,
                          // SMTP 配置
                          smtpConfig,
                          smtpConfigTls,
                          smtpConfigSsl,
                          savingSmtp,
                          testingSmtp,
                          loadSmtpConfig,
                          saveSmtpConfig,
                          testSmtpConfig,
                          // 管理员重置密码
                          resetPasswordUserId,
                          resetPasswordNew,
                          adminResetPassword,
                          // 忘记密码
                          showForgotPassword,
                          smtpEnabled,
                          smtpInfo,
                          forgotStep,
                          forgotEmail,
                          forgotCode,
                          forgotNewPassword,
                          sendingCode,
                          resettingPassword,
                          openForgotPassword,
                          closeForgotPassword,
                          sendResetCode,
                          resetPassword,
                          // 版本信息
                          versionInfo,
                          loadingVersion,
                          loadVersionInfo
                  };
            }
        }).mount('#app');
        </script>
</body>
</html>
