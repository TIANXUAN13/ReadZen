name: Docker Build & Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Git branch to build (e.g., main, dev, master)'
        required: false
        default: 'main'
      tag:
        description: 'Docker image tag (e.g., v1.0.0, latest)'
        required: false
        default: 'latest'
      password:
        description: 'Admin password for Docker image'
        required: false
        default: 'admin123'
      use_slim:
        description: 'Use docker-slim to optimize image size'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Debug inputs
        run: |
          echo "Input branch: ${{ github.event.inputs.branch }}"
          echo "Input tag: ${{ github.event.inputs.tag }}"
          echo "Input password: ${{ github.event.inputs.password }}"
          echo "Use docker-slim: ${{ github.event.inputs.use_slim }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/readzen
          tags: |
            type=raw,value=${{ github.event.inputs.tag || 'latest' }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/readzen:${{ github.event.inputs.tag || 'latest' }}
            readzen:original
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ADMIN_PASSWORD=${{ github.event.inputs.password || 'admin123' }}

      - name: Show original image size
        run: |
          echo "=== Original Docker Image Size ==="
          docker images readzen:original --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
          ORIGINAL_SIZE=$(docker inspect readzen:original --format '{{.Size}}')
          echo "Original size in bytes: ${ORIGINAL_SIZE}"
          echo "original_size=${ORIGINAL_SIZE}" >> $GITHUB_OUTPUT

      - name: Install docker-slim
        if: github.event.inputs.use_slim == 'true'
        run: |
          curl -sL https://github.com/docker-slim/docker-slim/releases/download/1.40.11/dist_linux.tar.gz -o dist_linux.tar.gz
          tar -xzf dist_linux.tar.gz
          sudo mv dist_linux/mint /usr/local/bin/mint
          sudo mv dist_linux/mint-sensor /usr/local/bin/mint-sensor
          sudo chmod +x /usr/local/bin/mint /usr/local/bin/mint-sensor
          mint --version

      - name: Optimize image with docker-slim
        if: github.event.inputs.use_slim == 'true'
        id: slim
        run: |
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/readzen"
          TAG="${{ github.event.inputs.tag || 'latest' }}"

          echo "=== Running docker-slim optimization ==="
          mint build \
            --target readzen:original \
            --tag ${IMAGE_NAME}:${TAG} \
            --tag readzen:slim \
            --http-probe \
            --expose 15000 \
            --include-path /app \
            --include-path /usr/local/lib \
            --env PORT=15000 \
            --env HOST=0.0.0.0

          echo "=== Slim Image Size ==="
          docker images readzen:slim --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
          SLIM_SIZE=$(docker inspect readzen:slim --format '{{.Size}}')
          echo "Slim size in bytes: ${SLIM_SIZE}"
          echo "slim_size=${SLIM_SIZE}" >> $GITHUB_OUTPUT

      - name: Compare image sizes
        if: github.event.inputs.use_slim == 'true'
        run: |
          echo ""
          echo "========================================"
          echo "Image Size Comparison"
          echo "========================================"

          ORIGINAL_SIZE=$(docker inspect readzen:original --format '{{.Size}}')
          SLIM_SIZE=$(docker inspect readzen:slim --format '{{.Size}}')

          echo "| Image | Size |"
          echo "|-------|------|"
          echo "| Original | $(numfmt --to=iec ${ORIGINAL_SIZE}) |"
          echo "| Optimized | $(numfmt --to=iec ${SLIM_SIZE}) |"

          REDUCTION=$((100 - (SLIM_SIZE * 100 / ORIGINAL_SIZE)))
          SAVED=$((ORIGINAL_SIZE - SLIM_SIZE))

          echo ""
          echo "Reduction: ${REDUCTION}%"
          echo "Space saved: $(numfmt --to=iec ${SAVED})"
          echo ""
          echo "original_size=${ORIGINAL_SIZE}" >> $GITHUB_OUTPUT
          echo "slim_size=${SLIM_SIZE}" >> $GITHUB_OUTPUT
          echo "reduction=${REDUCTION}" >> $GITHUB_OUTPUT

      - name: Tag non-slim image
        if: github.event.inputs.use_slim != 'true'
        run: |
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/readzen"
          TAG="${{ github.event.inputs.tag || 'latest' }}"
          docker tag readzen:original ${IMAGE_NAME}:${TAG}

      - name: Push Docker image
        run: |
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/readzen"
          TAG="${{ github.event.inputs.tag || 'latest' }}"
          docker push ${IMAGE_NAME}:${TAG}

      - name: Get tag value for comparison
        id: tag-info
        run: |
          TAG="${{ github.event.inputs.tag }}"
          BRANCH="${{ github.event.inputs.branch }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "is_latest=false" >> $GITHUB_OUTPUT
          if [ "$TAG" == "latest" ]; then
            echo "is_latest=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Release Asset
        if: steps.tag-info.outputs.is_latest == 'true'
        run: |
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/readzen"
          TAG="${{ steps.tag-info.outputs.tag }}"

          echo "=== Debug Info ==="
          echo "Image name: ${IMAGE_NAME}"
          echo "Tag: ${TAG}"
          echo "Branch: ${{ steps.tag-info.outputs.branch }}"

          echo ""
          echo "=== All local Docker images ==="
          docker images --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.Size}}" | head -20

          # Find first available image
          IMAGE_ID=$(docker images --format "{{.ID}}" | head -1)
          if [ -n "$IMAGE_ID" ]; then
            echo ""
            echo "=== Found image ID ==="
            echo "Image ID: ${IMAGE_ID}"
            docker save ${IMAGE_ID} -o readzen.tar
          else
            echo ""
            echo "=== No images found, trying by name ==="
            docker save ${IMAGE_NAME}:${TAG} -o readzen.tar 2>&1 || echo "Failed to save image"
          fi

          if [ -f readzen.tar ]; then
            echo ""
            echo "=== Creating checksum ==="
            sha256sum readzen.tar > readzen.tar.sha256
            ls -la readzen.tar
          else
            echo "ERROR: readzen.tar was not created!"
          fi

      - name: Upload Release Asset
        if: steps.tag-info.outputs.is_latest == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: Release ${{ github.event.inputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            readzen.tar
            readzen.tar.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          TAG="${{ github.event.inputs.tag }}"
          BRANCH="${{ github.event.inputs.branch }}"
          USE_SLIM="${{ github.event.inputs.use_slim }}"

          echo "## Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${BRANCH} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ secrets.DOCKERHUB_USERNAME }}/readzen:${TAG} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker-slim | ${USE_SLIM} |" >> $GITHUB_STEP_SUMMARY

          if [ "${USE_SLIM}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Image Size Comparison" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            ORIGINAL_SIZE=$(docker inspect readzen:original --format '{{.Size}}' 2>/dev/null || echo "0")
            SLIM_SIZE=$(docker inspect readzen:slim --format '{{.Size}}' 2>/dev/null || echo "0")

            if [ "$ORIGINAL_SIZE" != "0" ] && [ "$SLIM_SIZE" != "0" ]; then
              ORIGINAL_HUMAN=$(numfmt --to=iec ${ORIGINAL_SIZE})
              SLIM_HUMAN=$(numfmt --to=iec ${SLIM_SIZE})
              REDUCTION=$((100 - (SLIM_SIZE * 100 / ORIGINAL_SIZE)))

              echo "| Image | Size |" >> $GITHUB_STEP_SUMMARY
              echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
              echo "| Original | ${ORIGINAL_HUMAN} |" >> $GITHUB_STEP_SUMMARY
              echo "| Optimized | ${SLIM_HUMAN} |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reduction: ${REDUCTION}%**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "$TAG" != "latest" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Release created at: https://github.com/${{ github.repository }}/releases/tag/${TAG}" >> $GITHUB_STEP_SUMMARY
          fi
